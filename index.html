<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>매매 일지 분석 앱</title>
    <!-- PWA 관련 메타 태그 및 매니페스트 링크 -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png"> <!-- 나중에 실제 아이콘 경로로 변경 -->
    <meta name="theme-color" content="#6a994e"> <!-- 앱의 테마 색상 (상태 표시줄 등) -->

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK (v9 호환) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, updateDoc, addDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // 전역 변수 선언 (스코프 밖에서 접근 가능하도록)
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.currentUserId = null;
        window.userTradesCollectionRef = null;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.collection = collection;
        window.query = query;
        window.onSnapshot = onSnapshot;
        window.updateDoc = updateDoc; // updateDoc 추가
        window.addDoc = addDoc; // addDoc 추가
        window.arrayUnion = arrayUnion; // arrayUnion 추가
        window.arrayRemove = arrayRemove; // arrayRemove 추가

        // 사용자 정의 태그를 위한 전역 변수
        window.customPsychologyTags = [];
        window.customEntryBasisTags = [];
        window.customSuccessFactorsTags = []; // 추가
        window.customFailureFactorsTags = []; // 추가

        // 기본 심리 태그 및 진입 근거
        const predefinedPsychologyTags = [
            "사전에 준비된 자리", "사전에 준비되지 않은 자리", "조급함", "흥분상태",
            "복수매매", "냉철함", "우울함/무기력함", "피곤함", "비이성적",
            "복구 심리", "FOMO", "오기", "'이번만은' 심리", "욕심[5%이상의 고리스크]",
            "자신감", "성급한", "불안함", "리스크 계산함", "두려움", "추세", "역추세"
        ];
        const predefinedEntryBasisTags = [
            "피보나치 채널/비율", "일목균형표 (구름, 전환선 등)", "옵션", "금리선물 확인",
            "뉴스", "지표발표", "이평선", "미증시자리"
        ];
        // 미리 정의된 성공/실패 요인
        const predefinedSuccessFactors = [
            "진입 타이밍 정확", "계획대로 청산", "심리적 통제 성공", "시장 분석 적중", "자금 관리 준수"
        ];
        const predefinedFailureFactors = [
            "시그널 해석 오류", "계획 외 리스크 노출", "감정 개입", "오버트레이딩",
            "목표가 미흡/비현실적", "외부 뉴스 영향 받음", "시스템 외 매매", "손절가 이탈 미준수"
        ];

        // Google 인증 공급자 설정
        const googleProvider = new GoogleAuthProvider();
        window.signInWithGoogle = async function() {
            try {
                // signInWithPopup을 사용하여 팝업으로 로그인
                const result = await signInWithPopup(window.auth, googleProvider);
                // 로그인이 성공하면 onAuthStateChanged 리스너가 사용자 정보를 업데이트합니다.
                console.log("Google 로그인 성공:", result.user);
            } catch (error) {
                console.error("Google 로그인 실패:", error);
                const errorMessage = error.message;
                // 사용자에게 오류 메시지 표시
                document.getElementById('statusMessage').textContent = `Google 로그인 실패: ${errorMessage}`;
                document.getElementById('statusMessage').classList.remove('hidden');
                document.getElementById('statusMessage').classList.remove('text-green-600', 'bg-green-100', 'border-green-200');
                document.getElementById('statusMessage').classList.add('text-red-600', 'bg-red-100', 'border-red-200');
            }
        };

        window.signOutUser = async function() {
            try {
                await signOut(window.auth);
                console.log("로그아웃 성공");
                // 로그아웃 성공 시 상태 메시지 초기화 및 UI 업데이트 (onAuthStateChanged에 의해 처리됨)
                document.getElementById('statusMessage').textContent = '로그아웃되었습니다.';
                document.getElementById('statusMessage').classList.remove('hidden');
                document.getElementById('statusMessage').classList.remove('text-red-600', 'bg-red-100', 'border-red-200');
                document.getElementById('statusMessage').classList.add('text-green-600', 'bg-green-100', 'border-green-200');
            } catch (error) {
                console.error("로그아웃 실패:", error);
                document.getElementById('statusMessage').textContent = `로그아웃 실패: ${error.message}`;
                document.getElementById('statusMessage').classList.remove('hidden');
                document.getElementById('statusMessage').classList.remove('text-green-600', 'bg-green-100', 'border-red-200');
                document.getElementById('statusMessage').classList.add('text-red-600', 'bg-red-100', 'border-red-200');
            }
        };


        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Canvas 환경에서 제공되는 앱 ID
        // 사용자의 실제 Firebase 프로젝트 구성으로 아래 firebaseConfig 객체를 업데이트하세요.
        // Firebase 콘솔 (project settings -> General -> Your apps)에서 확인 가능합니다.
        // **이 부분을 정확히 채우지 않으면 로그인 및 데이터 저장 기능이 작동하지 않습니다.**
        const firebaseConfig = {
          apiKey: "AIzaSyDtbBNTsYJGIJIrj-V9kqyXXOiHm5u43RM", // <<< 실제 API Key로 변경
          authDomain: "future-futures-0u0.firebaseapp.com", // <<< 실제 Auth Domain으로 변경
          projectId: "future-futures-0u0", // <<< 실제 Project ID로 변경
          storageBucket: "future-futures-0u0.firebasestorage.app",
          messagingSenderId: "591254718769",
          appId: "1:591254718769:web:45eccbfb9b6ed922fc4810",
          measurementId: "G-6RGPM8RZGG"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; // Canvas 환경에서 제공되는 초기 인증 토큰

        // Helper functions for status/loading
        function showStatusMessage(message, type = 'info') {
            const statusMessageElement = document.getElementById('statusMessage');
            statusMessageElement.textContent = message;
            statusMessageElement.classList.remove('hidden', 'text-red-600', 'bg-red-100', 'border-red-200', 'text-green-600', 'bg-green-100', 'border-green-200');
            if (type === 'success') {
                statusMessageElement.classList.add('text-green-600', 'bg-green-100', 'border-green-200');
            } else if (type === 'error') {
                statusMessageElement.classList.add('text-red-600', 'bg-red-100', 'border-red-200');
            }
            statusMessageElement.classList.remove('hidden');
            setTimeout(() => { statusMessageElement.classList.add('hidden'); }, 3000); // Hide after 3 seconds
        }

        function showLoadingSpinner() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
        }

        function hideLoadingSpinner() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }

        // Firebase 초기화 및 인증
        async function initializeFirebase() {
            console.log("Initializing Firebase...");
            if (!firebaseConfig || !firebaseConfig.projectId || firebaseConfig.apiKey === "YOUR_API_KEY") { // Check for placeholder
                console.error("Firebase 초기화 실패: 'projectId' 또는 'apiKey'가 Firebase 설정에 올바르게 제공되지 않았습니다. 환경 변수 '__firebase_config'를 확인하거나, 하드코딩된 값을 업데이트해주세요.");
                showStatusMessage('Firebase 초기화 오류: 프로젝트 설정이 누락되었거나 올바르지 않습니다. 환경 설정을 확인해주세요.', 'error');
                hideLoadingSpinner();
                return; // 초기화 중단
            }

            try {
                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);

                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.currentUserId = user.uid;
                        let userIdentifier = `ID: ${user.uid}`; // 전체 UID 표시
                        if (user.isAnonymous) {
                            userIdentifier += ' - 익명';
                        } else if (user.email) {
                            userIdentifier += ` (${user.email}) - Google`;
                        }
                        document.getElementById('userIdDisplay').textContent = `사용자: ${userIdentifier}`;
                        
                        // 로그인 상태에 따라 로그인/로그아웃 버튼 표시 토글
                        document.getElementById('googleSignInBtn').classList.add('hidden');
                        document.getElementById('signOutBtn').classList.remove('hidden');

                        // 사용자 전용 컬렉션 경로 설정
                        window.userTradesCollectionRef = window.collection(window.db, `artifacts/${appId}/users/${window.currentUserId}/trades`);
                        // 사용자 정의 태그 컬렉션 경로 설정
                        window.userCustomTagsDocRef = window.doc(window.db, `artifacts/${appId}/users/${window.currentUserId}/settings/custom_tags`);
                        
                        setupRealtimeListener();
                        loadCustomTags(); // 사용자 정의 태그 로드
                        // 데이터 로딩 성공 또는 로그인 상태 변경 시 로딩 스피너 및 메시지 숨김
                        hideLoadingSpinner();
                        showStatusMessage('로그인 성공!', 'success');
                        // Initial setup for report period display based on default checked radio
                        // Ensure month selector is visible by default
                        reportMonthSelector.classList.remove('hidden');
                        reportMonthSelector.value = `${new Date().getFullYear()}-${(new Date().getMonth() + 1).toString().padStart(2, '0')}`;
                        
                        updateReports(); // Ensure initial report is correct
                    } else {
                        console.log("사용자 로그인되지 않음. 로그인 버튼 표시.");
                        // 사용자가 로그인되지 않은 경우 UI 업데이트
                        document.getElementById('userIdDisplay').textContent = '사용자: 로그인 필요';
                        document.getElementById('googleSignInBtn').classList.remove('hidden'); // 항상 보이도록
                        document.getElementById('signOutBtn').classList.add('hidden');

                        // 이전 사용자 데이터 클리어 (로그아웃 시 데이터 초기화)
                        window.trades = [];
                        window.customPsychologyTags = []; // 로그아웃 시 태그도 초기화
                        window.customEntryBasisTags = []; // 로그아웃 시 태그도 초기화
                        window.customSuccessFactorsTags = []; // 로그아웃 시 태그도 초기화
                        window.customFailureFactorsTags = []; // 로그아웃 시 태그도 초기화

                        renderTradeHistory();
                        updateDashboard();
                        updateReports();
                        renderTagCheckboxes(); // 체크박스 초기화
                        renderTagManagementSections(); // 태그 관리 섹션 초기화

                        hideLoadingSpinner(); // 익명 로그인 성공 시 스피너 숨김
                        showStatusMessage('로그아웃되었습니다.', 'info');
                        
                        // NOTE: For web deployment, signInAnonymously is removed from onAuthStateChanged
                        // as it conflicts with explicit Google sign-in flow and makes Google login "useless".
                        // Anonymous login will only occur if __initial_auth_token is provided by Canvas runtime
                        // or if a previous anonymous session persists.
                    }
                });

                // For Canvas runtime, try signing in with the provided token if available
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                    console.log("Canvas initial auth token login successful.");
                } else {
                    // For direct web access or if no initial token, UI waits for explicit sign-in
                    console.log("No initial auth token. Waiting for explicit user login.");
                }

            } catch (error) {
                console.error("Firebase 초기화 오류:", error);
                showStatusMessage('Firebase 초기화 오류: ' + error.message, 'error');
                hideLoadingSpinner();
            }
        }

        // 실시간 데이터 리스너 설정
        function setupRealtimeListener() {
            if (!window.userTradesCollectionRef) {
                console.warn("userTradesCollectionRef가 아직 설정되지 않았습니다.");
                showStatusMessage('데이터를 불러올 수 없습니다: 사용자 컬렉션 경로가 설정되지 않았습니다.', 'error');
                hideLoadingSpinner();
                return;
            }

            const q = window.query(window.userTradesCollectionRef);
            window.onSnapshot(q, (snapshot) => {
                const fetchedTrades = [];
                snapshot.forEach((doc) => {
                    fetchedTrades.push({ id: doc.id, ...doc.data() });
                });
                window.trades = fetchedTrades; // 전역 trades 변수 업데이트
                renderTradeHistory();
                updateDashboard();
                updateReports(); // 보고서 업데이트 추가
                hideLoadingSpinner();
                // showStatusMessage('데이터 로드 완료!', 'success'); // Commented out to avoid too many messages
            }, (error) => {
                console.error("Firebase 데이터 실시간 동기화 오류:", error);
                showStatusMessage('데이터 동기화 오류: ' + error.message, 'error');
                hideLoadingSpinner();
            });
        }

        // 사용자 정의 태그 로드
        async function loadCustomTags() {
            if (!window.userCustomTagsDocRef) {
                console.warn("userCustomTagsDocRef가 아직 설정되지 않았습니다.");
                return;
            }
            window.onSnapshot(window.userCustomTagsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.customPsychologyTags = data.psychologyTags || [];
                    window.customEntryBasisTags = data.entryBasisTags || [];
                    window.customSuccessFactorsTags = data.successFactorsTags || []; // 로드
                    window.customFailureFactorsTags = data.failureFactorsTags || []; // 로드
                } else {
                    window.customPsychologyTags = [];
                    window.customEntryBasisTags = [];
                    window.customSuccessFactorsTags = [];
                    window.customFailureFactorsTags = [];
                }
                renderTagCheckboxes();
                renderTagManagementSections();
                updateDashboard(); // ADDED: Update dashboard after custom tags are loaded/changed
            }, (error) => {
                console.error("사용자 정의 태그 로드 실패:", error);
                showStatusMessage('사용자 정의 태그 로드 실패: ' + error.message, 'error');
            });
        }

        // 사용자 정의 태그 저장
        async function saveCustomTags() {
            if (!window.userCustomTagsDocRef || !window.currentUserId) {
                showStatusMessage('태그 저장 실패: 로그인 상태를 확인해주세요.', 'error');
                return;
            }
            try {
                await window.setDoc(window.userCustomTagsDocRef, {
                    psychologyTags: window.customPsychologyTags,
                    entryBasisTags: window.customEntryBasisTags,
                    successFactorsTags: window.customSuccessFactorsTags, // 저장
                    failureFactorsTags: window.customFailureFactorsTags  // 저장
                }, { merge: true }); // 기존 필드는 유지하면서 병합
                showStatusMessage('태그가 성공적으로 저장되었습니다!', 'success');
            } catch (error) {
                console.error("태그 저장 실패:", error);
                showStatusMessage('태그 저장 실패: ' + error.message, 'error');
            }
        }

        // 태그 추가
        window.addCustomTag = async function(type) {
            const inputId = `new${type.charAt(0).toUpperCase() + type.slice(1)}Tag`;
            const newTagInput = document.getElementById(inputId);
            const newTag = newTagInput.value.trim();

            if (!newTag) {
                showStatusMessage('추가할 태그를 입력해주세요.', 'error');
                return;
            }

            let targetTags;
            let predefinedTags;
            if (type === 'psychology') {
                targetTags = window.customPsychologyTags;
                predefinedTags = predefinedPsychologyTags;
            } else if (type === 'entryBasis') {
                targetTags = window.customEntryBasisTags;
                predefinedTags = predefinedEntryBasisTags;
            } else if (type === 'successFactors') { // 성공 요인
                targetTags = window.customSuccessFactorsTags;
                predefinedTags = predefinedSuccessFactors;
            } else if (type === 'failureFactors') { // 실패 요인
                targetTags = window.customFailureFactorsTags;
                predefinedTags = predefinedFailureFactors;
            } else {
                return; // 잘못된 타입
            }
            
            if (predefinedTags.includes(newTag) || targetTags.includes(newTag)) {
                 showStatusMessage('이미 존재하거나 유효하지 않은 태그입니다.', 'error');
                 return;
            }

            targetTags.push(newTag);
            newTagInput.value = '';
            await saveCustomTags();
            renderTagCheckboxes();
            renderTagManagementSections();
        };

        // 태그 삭제
        window.deleteCustomTag = async function(type, tag) {
            // 커스텀 모달 사용 (confirm 대신)
            showCustomConfirmationModal(`'${tag}' 태그를 삭제하시겠습니까?`, async () => {
                if (type === 'psychology') {
                    window.customPsychologyTags = window.customPsychologyTags.filter(t => t !== tag);
                } else if (type === 'entryBasis') {
                    window.customEntryBasisTags = window.customEntryBasisTags.filter(t => t !== tag);
                } else if (type === 'successFactors') {
                    window.customSuccessFactorsTags = window.customSuccessFactorsTags.filter(t => t !== tag);
                } else if (type === 'failureFactors') {
                    window.customFailureFactorsTags = window.customFailureFactorsTags.filter(t => t !== tag);
                }
                await saveCustomTags();
                renderTagCheckboxes();
                renderTagManagementSections();
            });
        };

        // 매매 기록 폼에 태그 체크박스 동적 렌더링
        function renderTagCheckboxes() {
            const psychologyContainer = document.getElementById('psychologyCheckboxes');
            const entryBasisContainer = document.getElementById('entryBasisCheckboxes');
            const successFactorsContainer = document.getElementById('successFactorsCheckboxes'); // 추가
            const failureFactorsContainer = document.getElementById('failureFactorsCheckboxes'); // 추가


            // Ensure containers exist before attempting to manipulate them
            if (!psychologyContainer || !entryBasisContainer || !successFactorsContainer || !failureFactorsContainer) {
                console.error("Tag checkbox containers not found in DOM.");
                return;
            }

            // Clear existing content to prevent duplication
            psychologyContainer.innerHTML = '';
            entryBasisContainer.innerHTML = '';
            successFactorsContainer.innerHTML = ''; 
            failureFactorsContainer.innerHTML = ''; 

            // 2-1 상태 기반 심리
            const stateBasedPsyHeader = document.createElement('h4');
            stateBasedPsyHeader.className = "font-medium text-lg mb-2 mt-6 text-gray-700 dark:text-gray-200 col-span-full"; // Added col-span-full
            stateBasedPsyHeader.textContent = "2-1 상태 기반 심리 [현재의 내 심리는?]";
            psychologyContainer.appendChild(stateBasedPsyHeader);

            const stateBasedPsychology = [
                "사전에 준비된 자리", "사전에 준비되지 않은 자리", "조급함", "흥분상태",
                "복수매매", "냉철함", "우울함/무기력함", "피곤함", "비이성적"
            ];
            stateBasedPsychology.forEach(tag => {
                const label = document.createElement('label');
                label.className = "block text-gray-600 dark:text-gray-300"; // Dark mode: Ensure text color
                label.innerHTML = `<input type="checkbox" name="psychology" value="${tag}" class="mr-2">${tag}`;
                psychologyContainer.appendChild(label);
            });
            psychologyContainer.appendChild(document.createElement('div')).className = "mb-4 col-span-full"; // Added col-span-full

            // 2-2 일반 심리
            const generalPsyHeader = document.createElement('h4');
            generalPsyHeader.className = "font-medium text-lg mb-2 mt-6 text-gray-700 dark:text-gray-200 col-span-full"; // Added col-span-full
            generalPsyHeader.textContent = "2-2 일반 심리";
            psychologyContainer.appendChild(generalPsyHeader);

            const generalPsychology = [
                "복구 심리", "FOMO", "오기", "'이번만은' 심리", "욕심[5%이상의 고리스크]",
                "자신감", "성급한", "불안함", "리스크 계산함", "두려움", "추세", "역추세"
            ];
            generalPsychology.forEach(tag => {
                const label = document.createElement('label');
                label.className = "block text-gray-600 dark:text-gray-300"; // Dark mode: Ensure text color
                label.innerHTML = `<input type="checkbox" name="psychology" value="${tag}" class="mr-2">${tag}`;
                psychologyContainer.appendChild(label);
            });
            psychologyContainer.appendChild(document.createElement('div')).className = "mb-4 col-span-full"; // Added col-span-full


            // 2-3 사용자 정의 심리 태그 (Dynamic)
            if (window.customPsychologyTags.length > 0) {
                const customPsyHeader = document.createElement('h4');
                customPsyHeader.className = "font-medium text-lg mb-2 mt-6 text-gray-700 dark:text-gray-200 col-span-full"; // Added col-span-full
                customPsyHeader.textContent = "2-3 사용자 정의 심리 태그";
                psychologyContainer.appendChild(customPsyHeader);
                window.customPsychologyTags.forEach(tag => {
                    const label = document.createElement('label');
                    label.className = "block text-gray-600 dark:text-gray-300"; // Dark mode: Ensure text color
                    label.innerHTML = `<input type="checkbox" name="psychology" value="${tag}" class="mr-2">${tag}`;
                    psychologyContainer.appendChild(label);
                });
                psychologyContainer.appendChild(document.createElement('div')).className = "mb-4 col-span-full"; // Added col-span-full
            }


            // 3-1 신호 기반
            const signalBasedEntryHeader = document.createElement('h4');
            signalBasedEntryHeader.className = "font-medium text-lg mb-2 col-span-full mt-6 text-gray-700 dark:text-gray-200"; // More prominent heading
            signalBasedEntryHeader.textContent = "3-1 신호 기반";
            entryBasisContainer.appendChild(signalBasedEntryHeader);

            predefinedEntryBasisTags.forEach(tag => {
                const label = document.createElement('label');
                label.className = "block text-gray-600 dark:text-gray-300"; // Dark mode: Ensure text color
                label.innerHTML = `<input type="checkbox" name="entryBasis" value="${tag}" class="mr-2">${tag}`;
                entryBasisContainer.appendChild(label);
            });
            entryBasisContainer.appendChild(document.createElement('div')).className = "mb-4 col-span-full"; // Added col-span-full


            // 사용자 정의 진입 근거 태그 (Dynamic)
            if (window.customEntryBasisTags.length > 0) {
                const customEntryHeader = document.createElement('h4');
                customEntryHeader.className = "font-medium text-lg mb-2 mt-6 col-span-full text-gray-700 dark:text-gray-200"; // More prominent heading
                customEntryHeader.textContent = "3-2 사용자 정의 진입 근거 태그";
                entryBasisContainer.appendChild(customEntryHeader);
                window.customEntryBasisTags.forEach(tag => {
                    const label = document.createElement('label');
                    label.className = "block text-gray-600 dark:text-gray-300"; // Dark mode: Ensure text color
                    label.innerHTML = `<input type="checkbox" name="entryBasis" value="${tag}" class="mr-2">${tag}`;
                    entryBasisContainer.appendChild(label);
                });
                entryBasisContainer.appendChild(document.createElement('div')).className = "mb-4 col-span-full"; // Added col-span-full
            }

            // b-1 성공 요인 진단
            const successFactorsHeader = document.createElement('h4');
            successFactorsHeader.className = "font-medium mb-2 mt-6 text-gray-700 dark:text-gray-200 col-span-full"; // Added col-span-full
            successFactorsHeader.textContent = "b-1 성공요인";
            successFactorsContainer.appendChild(successFactorsHeader);
            predefinedSuccessFactors.forEach(factor => {
                const label = document.createElement('label');
                label.className = "block text-gray-600 dark:text-gray-300";
                label.innerHTML = `<input type="checkbox" name="successFactor" value="${factor}" class="mr-2">${factor}`;
                successFactorsContainer.appendChild(label);
            });
            window.customSuccessFactorsTags.forEach(factor => {
                const label = document.createElement('label');
                label.className = "block text-gray-600 dark:text-gray-300";
                label.innerHTML = `<input type="checkbox" name="successFactor" value="${factor}" class="mr-2">${factor}`;
                successFactorsContainer.appendChild(label);
            });
            successFactorsContainer.appendChild(document.createElement('div')).className = "mb-4 col-span-full"; // Added col-span-full


            // b-2 실패 요인 진단
            const failureFactorsHeader = document.createElement('h4');
            failureFactorsHeader.className = "font-medium mb-2 mt-6 text-gray-700 dark:text-gray-200 col-span-full"; // Added col-span-full
            failureFactorsHeader.textContent = "b-2 실패요인";
            failureFactorsContainer.appendChild(failureFactorsHeader);
            predefinedFailureFactors.forEach(factor => {
                const label = document.createElement('label');
                label.className = "block text-gray-600 dark:text-gray-300";
                label.innerHTML = `<input type="checkbox" name="failureFactor" value="${factor}" class="mr-2">${factor}`;
                failureFactorsContainer.appendChild(label);
            });
            window.customFailureFactorsTags.forEach(factor => {
                const label = document.createElement('label');
                label.className = "block text-gray-600 dark:text-gray-300";
                label.innerHTML = `<input type="checkbox" name="failureFactor" value="${factor}" class="mr-2">${factor}`;
                failureFactorsContainer.appendChild(label);
            });
            failureFactorsContainer.appendChild(document.createElement('div')).className = "mb-4 col-span-full"; // Added col-span-full
        }

        // 태그 관리 섹션 렌더링
        function renderTagManagementSections() {
            const psychologyTagsDisplay = document.getElementById('psychologyTagsDisplay');
            const entryBasisTagsDisplay = document.getElementById('entryBasisTagsDisplay');
            const successFactorsTagsDisplay = document.getElementById('successFactorsTagsDisplay'); // 추가
            const failureFactorsTagsDisplay = document.getElementById('failureFactorsTagsDisplay'); // 추가


            // 요소가 존재하는지 확인 후 렌더링
            if (psychologyTagsDisplay) psychologyTagsDisplay.innerHTML = '';
            if (entryBasisTagsDisplay) entryBasisTagsDisplay.innerHTML = '';
            if (successFactorsTagsDisplay) successFactorsTagsDisplay.innerHTML = ''; // 초기화
            if (failureFactorsTagsDisplay) failureFactorsTagsDisplay.innerHTML = ''; // 초기화


            window.customPsychologyTags.forEach(tag => {
                const span = document.createElement('span');
                span.className = "inline-flex items-center bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full mr-2 mb-2 dark:bg-blue-900 dark:text-blue-200";
                span.innerHTML = `${tag} <button onclick="deleteCustomTag('psychology', '${tag}')" class="ml-1 text-blue-600 hover:text-blue-900 dark:text-blue-300 dark:hover:text-blue-500 font-bold leading-none">&times;</button>`;
                if (psychologyTagsDisplay) psychologyTagsDisplay.appendChild(span);
            });

            window.customEntryBasisTags.forEach(tag => {
                const span = document.createElement('span');
                span.className = "inline-flex items-center bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full mr-2 mb-2 dark:bg-green-900 dark:text-green-200";
                span.innerHTML = `${tag} <button onclick="deleteCustomTag('entryBasis', '${tag}')" class="ml-1 text-green-600 hover:text-green-900 dark:text-green-300 dark:hover:text-green-500 font-bold leading-none">&times;</button>`;
                if (entryBasisTagsDisplay) entryBasisTagsDisplay.appendChild(span);
            });

            window.customSuccessFactorsTags.forEach(tag => {
                const span = document.createElement('span');
                span.className = "inline-flex items-center bg-purple-100 text-purple-800 text-xs font-medium px-2.5 py-0.5 rounded-full mr-2 mb-2 dark:bg-purple-900 dark:text-purple-200";
                span.innerHTML = `${tag} <button onclick="deleteCustomTag('successFactors', '${tag}')" class="ml-1 text-purple-600 hover:text-purple-900 dark:text-purple-300 dark:hover:text-purple-500 font-bold leading-none">&times;</button`;
                if (successFactorsTagsDisplay) successFactorsTagsDisplay.appendChild(span);
            });

            window.customFailureFactorsTags.forEach(tag => {
                const span = document.createElement('span');
                span.className = "inline-flex items-center bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full mr-2 mb-2 dark:bg-red-900 dark:text-red-200";
                span.innerHTML = `${tag} <button onclick="deleteCustomTag('failureFactors', '${tag}')" class="ml-1 text-red-600 hover:text-red-900 dark:text-red-300 dark:hover:text-red-500 font-bold leading-none">&times;</button>`;
                if (failureFactorsTagsDisplay) failureFactorsTagsDisplay.appendChild(span);
            });
        }


        // Dark Mode Toggle Logic
        window.toggleDarkMode = function() {
            document.documentElement.classList.toggle('dark-mode');
            const isDarkMode = document.documentElement.classList.contains('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            updateChartColors(isDarkMode); // 차트 색상 업데이트
        };

        // Custom confirmation modal functions
        let customConfirmCallback = null; // Callback for confirm action

        function showCustomConfirmationModal(message, callback) {
            document.getElementById('confirmModalMessage').textContent = message;
            customConfirmCallback = callback;
            confirmModalOverlay.classList.remove('hidden');
        }

        function hideCustomConfirmationModal() {
            confirmModalOverlay.classList.add('hidden');
            customConfirmCallback = null;
        }
        
        // 차트 색상 업데이트 함수 (다크 모드 전환 시 호출)
        function updateChartColors(isDarkMode) {
            const rootStyle = getComputedStyle(document.documentElement);
            const resolvedTextColor = isDarkMode ? rootStyle.getPropertyValue('--text-primary') : '#333';
            const resolvedGridColor = isDarkMode ? rootStyle.getPropertyValue('--chart-grid-color') : 'rgba(0, 0, 0, 0.1)';
            const tooltipFontColor = isDarkMode ? '#1a1a1a' : '#ffffff';
            const tooltipBgColor = isDarkMode ? '#e2e8f0' : 'rgba(0, 0, 0, 0.8)';

            // Set global Chart.js default font color
            Chart.defaults.color = resolvedTextColor; // Use resolved color
            Chart.defaults.font.family = 'Inter, sans-serif'; // Maintain font consistency

            // Common scale options for bar charts and horizontal bar charts
            const commonScalesOptions = (isVertical = true) => ({
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: { size: 12 },
                            color: resolvedTextColor // Will be dynamically set by updateChartColors
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                return isVertical ? `${label}${context.parsed.y.toFixed(2)}%` : `${label}${context.parsed.x}`;
                            }
                        }
                    }
                },
                scales: {
                    [isVertical ? 'y' : 'x']: { // Y-axis for vertical, X-axis for horizontal
                        beginAtZero: true,
                        max: isVertical ? 100 : undefined, // Only for percentage charts
                        ticks: {
                            color: resolvedTextColor, // Use resolved color
                            callback: isVertical ? function(value) { return value + '%'; } : undefined,
                            precision: isVertical ? undefined : 0
                        },
                        grid: {
                            display: true,
                            drawBorder: false,
                            color: resolvedGridColor // Use resolved color
                        }
                    },
                    [isVertical ? 'x' : 'y']: { // X-axis for vertical, Y-axis for horizontal
                        ticks: {
                            color: resolvedTextColor, // Use resolved color
                            callback: function(value, index, values) { return wrapLabel(this.getLabelForValue(value), isVertical ? 16 : 25); },
                            autoSkip: false,
                            maxRotation: isVertical ? 45 : 0,
                            minRotation: 0
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                layout: {
                    padding: { left: 20, right: 20, top: 20, bottom: 20 }
                }
            });

            // Result Breakdown Chart (Doughnut)
            if (resultBreakdownChart) {
                resultBreakdownChart.options.plugins.legend.labels.color = resolvedTextColor;
                resultBreakdownChart.update();
            }

            // Bar Charts
            if (psychologyImpactChart) {
                // Manually update properties to avoid recreating the chart
                Object.assign(psychologyImpactChart.options.scales, commonScalesOptions(true).scales);
                psychologyImpactChart.options.plugins.legend.labels.color = resolvedTextColor;
                psychologyImpactChart.update();
            }
            if (entryBasisEffectivenessChart) {
                Object.assign(entryBasisEffectivenessChart.options.scales, commonScalesOptions(true).scales);
                entryBasisEffectivenessChart.options.plugins.legend.labels.color = resolvedTextColor;
                entryBasisEffectivenessChart.update();
            }
            if (successFactorChart) {
                Object.assign(successFactorChart.options.scales, commonScalesOptions(false).scales);
                successFactorChart.options.plugins.legend.labels.color = resolvedTextColor;
                successFactorChart.update();
            }
            if (failureFactorChart) {
                Object.assign(failureFactorChart.options.scales, commonScalesOptions(false).scales);
                failureFactorChart.options.plugins.legend.labels.color = resolvedTextColor;
                failureFactorChart.update();
            }
            if (tradeDurationWinRateChart) { // NEW: Update trade duration chart colors
                Object.assign(tradeDurationWinRateChart.options.scales, commonScalesOptions(true).scales);
                tradeDurationWinRateChart.options.plugins.legend.labels.color = resolvedTextColor;
                tradeDurationWinRateChart.update();
            }
            
            // Chart tooltip text color update
            [resultBreakdownChart, psychologyImpactChart, entryBasisEffectivenessChart, successFactorChart, failureFactorChart, tradeDurationWinRateChart].forEach(chart => {
                if (chart && chart.options && chart.options.plugins && chart.options.plugins.tooltip) {
                    chart.options.plugins.tooltip.titleColor = tooltipFontColor;
                    chart.options.plugins.tooltip.bodyColor = tooltipFontColor;
                    chart.options.plugins.tooltip.backgroundColor = tooltipBgColor;
                    chart.options.plugins.tooltip.borderColor = isDarkMode ? rootStyle.getPropertyValue('--text-link') : rootStyle.getPropertyValue('--button-primary-bg');
                    chart.options.plugins.tooltip.borderWidth = 1;
                }
            });
        }


        // Window onload에서 Firebase 초기화 호출
        window.onload = function() {
            console.log("Window loaded, starting initialization...");
            // 저장된 테마 설정 로드
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark-mode');
            }
            
            // HTML 요소들을 찾기 위한 변수들을 스크립트 상단으로 이동하거나, 직접 접근하도록 변경
            // 모달 닫기 버튼 이벤트
            const confirmModalCloseBtn = document.getElementById('confirmModalClose');
            if (confirmModalCloseBtn) { // 요소가 존재하는지 확인
                confirmModalCloseBtn.addEventListener('click', hideCustomConfirmationModal);
            }
            const cancelDeleteBtn = document.getElementById('cancelDelete');
            if (cancelDeleteBtn) { // 요소가 존재하는지 확인
                cancelDeleteBtn.addEventListener('click', hideCustomConfirmationModal);
            }

            // Custom modal confirm button listener
            document.getElementById('confirmActionButton').addEventListener('click', () => {
                if (customConfirmCallback) {
                    customConfirmCallback();
                }
                hideCustomConfirmationModal();
            });

            // --- 이벤트 리스너를 동적으로 연결하도록 수정된 부분 ---
            const googleSignInBtn = document.getElementById('googleSignInBtn');
            if (googleSignInBtn) {
                googleSignInBtn.addEventListener('click', window.signInWithGoogle);
            }

            const signOutBtn = document.getElementById('signOutBtn');
            if (signOutBtn) {
                signOutBtn.addEventListener('click', window.signOutUser);
            }

            const darkModeToggleBtn = document.getElementById('darkModeToggle');
            if (darkModeToggleBtn) {
                darkModeToggleBtn.addEventListener('click', window.toggleDarkMode);
            }
            // --- 수정된 부분 끝 ---


            document.getElementById('date').value = new Date().toISOString().split('T')[0]; // Set default entry date to today
            // Firebase 초기화는 다른 모든 UI 로직보다 먼저 호출
            initializeFirebase(); 
            initializeCharts(); // 차트 초기화는 Firebase 초기화 후 호출 (데이터 종속성 고려)
            updateChartColors(savedTheme === 'dark'); // 다크 모드 초기화 후 차트 색상 업데이트
            updateResultFieldRequirements(); // Set initial required status

            // Add event listener for exchange rate input
            const exchangeRateInput = document.getElementById('exchangeRateInput');
            if (exchangeRateInput) {
                exchangeRateInput.addEventListener('input', updateReports);
            }
            
            // Service Worker 등록
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('Service Worker 등록 성공:', registration);
                    })
                    .catch(error => {
                        console.error('Service Worker 등록 실패:', error);
                    });
            }
        };


        const tradeForm = document.getElementById('tradeForm');
        const tradeHistoryBody = document.getElementById('tradeHistoryBody');
        window.trades = []; // Firebase에서 관리되므로 초기화 시 빈 배열로 시작합니다.

        // Chart instances, will be initialized in initializeCharts()
        let resultBreakdownChart;
        let psychologyImpactChart;
        let entryBasisEffectivenessChart;
        let successFactorChart; // Renamed from factorAnalysisChart and split
        let failureFactorChart; // Added for failure factors
        let tradeDurationWinRateChart; // NEW: Trade Duration Chart instance

        const resultOutcomeSelect = document.getElementById('resultOutcome');
        const rRatioInput = document.getElementById('rRatio');
        const pnlAmountInput = document.getElementById('pnlAmount'); // ADDED: PNL input reference
        const pnlCurrencyKRW = document.getElementById('pnlCurrencyKRW'); // ADDED
        const pnlCurrencyUSD = document.getElementById('pnlCurrencyUSD'); // ADDED
        const exitReasonSelect = document.getElementById('exitReason');
        const replayQuestion1Select = document.getElementById('replayQuestion1');
        const replayQuestion2Textarea = document.getElementById('replayQuestion2');
        const replayQuestion3Input = document.getElementById('replayQuestion3');
        const exitDateInput = document.getElementById('exitDate');

        let currentEditingTradeId = null; // 수정 중인 매매 ID 추적

        // 모달 관련 요소 (기존 confirmModalOverlay는 삭제 확인용으로 재활용)
        const confirmModalOverlay = document.getElementById('confirmModalOverlay');
        const confirmDeleteButton = document.getElementById('confirmDelete');
        let tradeIdToDelete = null;

        // Get references to the monthly and quarterly selectors
        const reportMonthSelector = document.getElementById('reportMonthSelector');
        // const quarterButtonsContainer = document.getElementById('quarterButtonsContainer'); // Removed as per user request


        // Utility function to wrap long labels
        function wrapLabel(label, maxCharsPerLine) {
            if (typeof label !== 'string') return label;
            if (label.length <= maxCharsPerLine) return label;
            const words = label.split(' ');
            let lines = [];
            let currentLine = '';
            words.forEach(word => {
                if ((currentLine + word).length > maxCharsPerLine && currentLine.length > 0) {
                    lines.push(currentLine.trim());
                    currentLine = word + ' ';
                } else {
                    currentLine += word + ' ';
                }
            });
            lines.push(currentLine.trim());
            return lines;
        }

        // Helper function to format numbers with commas
        function formatNumberWithCommas(number) {
            if (number === null || isNaN(number)) {
                return '-';
            }
            // For PNL, we need to ensure it's a number, then format
            const num = parseFloat(number);
            return num.toLocaleString('en-US'); // 'en-US' uses comma as thousands separator
        }

        // Initialize Charts (This function needs to be defined BEFORE it's called in window.onload)
        function initializeCharts() {
            // Get computed style once to initialize with correct colors
            const rootStyle = getComputedStyle(document.documentElement);
            const initialTextColor = document.documentElement.classList.contains('dark-mode') ? rootStyle.getPropertyValue('--text-primary') : '#333';
            const initialGridColor = document.documentElement.classList.contains('dark-mode') ? rootStyle.getPropertyValue('--chart-grid-color') : 'rgba(0, 0, 0, 0.1)';

            // Common options for vertical bar charts (Psychology Impact, Entry Basis Effectiveness)
            const commonVerticalBarChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: { size: 12 },
                            color: initialTextColor // Will be dynamically set by updateChartColors
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== undefined) { label += context.parsed.y.toFixed(2) + '%'; }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) { return value + '%'; },
                            color: initialTextColor // Will be dynamically set by updateChartcolors
                        },
                        grid: {
                            display: true,
                            drawBorder: false,
                            color: initialGridColor // Will be dynamically set by updateChartColors
                        }
                    },
                    x: {
                        ticks: {
                            color: initialTextColor, // Will be dynamically set by updateChartcolors
                            callback: function(value, index, values) { return wrapLabel(this.getLabelForValue(value), 16); },
                            autoSkip: false,
                            maxRotation: 45,
                            minRotation: 0
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                layout: {
                    padding: { left: 20, right: 20, top: 20, bottom: 20 }
                }
            };

            // Common options for Horizontal Bar Charts (Success/Failure Factors)
            const commonHorizontalBarChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', // Horizontal bar chart
                plugins: {
                    legend: {
                        display: false, // No legend needed if only one dataset per chart
                        labels: {
                            font: { size: 12 },
                            color: initialTextColor // Will be dynamically set by updateChartColors
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                label += context.parsed.x; // Value is on x-axis for horizontal bar
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0,
                            color: initialTextColor // Will be dynamically set by updateChartColors
                        },
                        grid: {
                            color: initialGridColor // Will be dynamically set by updateChartColors
                        }
                    },
                    y: {
                        ticks: {
                            color: initialTextColor, // Will be dynamically set by updateChartColors
                            callback: function(value, index, values) { return wrapLabel(this.getLabelForValue(value), 25); },
                            autoSkip: false,
                            maxRotation: 0,
                            minRotation: 0
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                layout: {
                    padding: { left: 20, right: 20, top: 20, bottom: 20 }
                }
            };


            const resultBreakdownCtx = document.getElementById('resultBreakdownChart').getContext('2d');
            resultBreakdownChart = new Chart(resultBreakdownCtx, {
                type: 'doughnut',
                data: {
                    labels: ['수익', '손절', '본절', '진행 중'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#6a994e', '#d9534f', '#f0ad4e', '#888888'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 12 },
                                color: initialTextColor // Will be dynamically set by updateChartColors
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                                    const percentage = total > 0 ? (value / total * 100).toFixed(2) : 0;
                                    return `${label}: ${percentage}%`;
                                }
                            }
                        }
                    },
                    layout: {
                        padding: { left: 10, right: 10, top: 10, bottom: 10 }
                    }
                }
            });

            const psychologyImpactCtx = document.getElementById('psychologyImpactChart').getContext('2d');
            psychologyImpactChart = new Chart(psychologyImpactCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '승률 (%)',
                        data: [],
                        backgroundColor: '#a0c4ff',
                        borderColor: '#80b0f0',
                        borderWidth: 1
                    }]
                },
                options: commonVerticalBarChartOptions
            });

            const entryBasisEffectivenessCtx = document.getElementById('entryBasisEffectivenessChart').getContext('2d');
            entryBasisEffectivenessChart = new Chart(entryBasisEffectivenessCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '승률 (%)',
                        data: [],
                        backgroundColor: '#6a994e',
                        borderColor: '#5a8542',
                        borderWidth: 1
                    }]
                },
                options: commonVerticalBarChartOptions
            });

            // New chart for Success Factors
            const successFactorCtx = document.getElementById('successFactorChart').getContext('2d');
            successFactorChart = new Chart(successFactorCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '성공 요인 빈도',
                        data: [],
                        backgroundColor: '#86efac', // Green-ish for success
                        borderColor: '#4ade80',
                        borderWidth: 1
                    }]
                },
                options: commonHorizontalBarChartOptions
            });

            // New chart for Failure Factors
            const failureFactorCtx = document.getElementById('failureFactorChart').getContext('2d');
            failureFactorChart = new Chart(failureFactorCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '실패 요인 빈도',
                        data: [],
                        backgroundColor: '#fca5a5', // Red-ish for failure
                        borderColor: '#ef4444',
                        borderWidth: 1
                    }]
                },
                options: commonHorizontalBarChartOptions
            });

            // NEW: Trade Duration Win Rate Chart
            const tradeDurationWinRateCtx = document.getElementById('tradeDurationWinRateChart').getContext('2d');
            tradeDurationWinRateChart = new Chart(tradeDurationWinRateCtx, {
                type: 'bar',
                data: {
                    labels: ['Day', 'Swing', 'LongTerm'], // Fixed labels
                    datasets: [{
                        label: '승률 (%)',
                        data: [0, 0, 0], // Initial data
                        backgroundColor: ['#ffdd77', '#77ddff', '#ff77aa'], // Different colors
                        borderColor: ['#eebb44', '#44aadd', '#ee4477'],
                        borderWidth: 1
                    }]
                },
                options: commonVerticalBarChartOptions // Reuse common options
            });
        }

        // Update Charts and Summary
        function updateDashboard() {
            if (!window.trades) {
                console.warn("Trades data is not available yet.");
                return;
            }
            const completedTrades = window.trades.filter(t => t.resultOutcome !== '진행 중');

            // Overall Performance
            const totalTrades = completedTrades.length;
            document.getElementById('totalTrades').textContent = formatNumberWithCommas(totalTrades); // Apply comma formatting

            const winTrades = completedTrades.filter(t => t.resultOutcome === '수익').length;
            const winRate = totalTrades > 0 ? (winTrades / totalTrades * 100).toFixed(2) : 0;
            document.getElementById('winRate').textContent = `${winRate}%`;

            const totalRR = completedTrades.reduce((sum, t) => sum + (parseFloat(t.rRatio) || 0), 0);
            const avgRR = totalTrades > 0 ? (totalRR / totalTrades).toFixed(2) : 0;
            document.getElementById('avgRR').textContent = formatNumberWithCommas(avgRR); // Apply comma formatting

            // Result Breakdown Chart
            const resultCounts = { '수익': 0, '손절': 0, '본절': 0, '진행 중': 0 };
            window.trades.forEach(trade => {
                if (resultCounts[trade.resultOutcome] !== undefined) {
                    resultCounts[trade.resultOutcome]++;
                }
            });
            if (resultBreakdownChart) { // Ensure chart exists before updating
                resultBreakdownChart.data.datasets[0].data = [resultCounts['수익'], resultCounts['손절'], resultCounts['본절'], resultCounts['진행 중']];
                resultBreakdownChart.update();
            }


            // Psychology Impact Chart (only for completed trades)
            const psychologyWinRates = {};
            const allPsychologyTags = new Set([...predefinedPsychologyTags, ...window.customPsychologyTags]); // 미리 정의된 태그와 사용자 정의 태그 결합

            completedTrades.forEach(trade => {
                const psychologyTags = Array.isArray(trade.psychology) ? trade.psychology : [];
                psychologyTags.forEach(tag => {
                    if (!psychologyWinRates[tag]) {
                        psychologyWinRates[tag] = { wins: 0, total: 0 };
                    }
                    psychologyWinRates[tag].total++;
                    if (trade.resultOutcome === '수익') {
                        psychologyWinRates[tag].wins++;
                    }
                });
            });

            const psychologyLabels = Array.from(allPsychologyTags).sort();
            const psychologyData = psychologyLabels.map(tag => {
                if (psychologyWinRates[tag] && psychologyWinRates[tag].total > 0) {
                    return (psychologyWinRates[tag].wins / psychologyWinRates[tag].total * 100).toFixed(2);
                }
                return 0; // 데이터가 없는 태그는 0%
            });

            if (psychologyImpactChart) { // Ensure chart exists before updating
                psychologyImpactChart.data.labels = psychologyLabels;
                psychologyImpactChart.data.datasets[0].data = psychologyData;
                psychologyImpactChart.update();
            }


            // Entry Basis Effectiveness Chart (only for completed trades)
            const entryBasisWinRates = {};
            const allEntryBasisTags = new Set([...predefinedEntryBasisTags, ...window.customEntryBasisTags]); // 미리 정의된 태그와 사용자 정의 태그 결합

            completedTrades.forEach(trade => {
                const entryBasisTags = Array.isArray(trade.entryBasis) ? trade.entryBasis : [];
                entryBasisTags.forEach(tag => {
                    if (!entryBasisWinRates[tag]) {
                        entryBasisWinRates[tag] = { wins: 0, total: 0 };
                    }
                    entryBasisWinRates[tag].total++;
                    if (trade.resultOutcome === '수익') {
                        entryBasisWinRates[tag].wins++;
                    }
                });
            });

            const entryBasisLabels = Array.from(allEntryBasisTags).sort();
            const entryBasisData = entryBasisLabels.map(tag => {
                if (entryBasisWinRates[tag] && entryBasisWinRates[tag].total > 0) {
                    return (entryBasisWinRates[tag].wins / entryBasisWinRates[tag].total * 100).toFixed(2);
                }
                return 0; // 데이터가 없는 태그는 0%
            });

            if (entryBasisEffectivenessChart) { // Ensure chart exists before updating
                entryBasisEffectivenessChart.data.labels = entryBasisLabels;
                entryBasisEffectivenessChart.data.datasets[0].data = entryBasisData;
                entryBasisEffectivenessChart.update();
            }


            // Success Factor Analysis Chart (NEW)
            const successFactorCounts = {};
            const allSuccessFactors = new Set([
                ...predefinedSuccessFactors,
                ...window.customSuccessFactorsTags
            ]);

            completedTrades.forEach(trade => {
                if (trade.successFactors && Array.isArray(trade.successFactors)) {
                    trade.successFactors.forEach(factor => {
                        successFactorCounts[factor] = (successFactorCounts[factor] || 0) + 1;
                    });
                }
            });

            const successFactorLabels = Array.from(allSuccessFactors).sort();
            const successFactorData = successFactorLabels.map(label => successFactorCounts[label] || 0);

            if (successFactorChart) {
                successFactorChart.data.labels = successFactorLabels;
                successFactorChart.data.datasets[0].data = successFactorData;
                successFactorChart.update();
            }

            // Failure Factor Analysis Chart (NEW)
            const failureFactorCounts = {};
            const allFailureFactors = new Set([
                ...predefinedFailureFactors,
                ...window.customFailureFactorsTags
            ]);

            completedTrades.forEach(trade => {
                if (trade.failureFactors && Array.isArray(trade.failureFactors)) {
                    trade.failureFactors.forEach(factor => {
                        failureFactorCounts[factor] = (failureFactorCounts[factor] || 0) + 1;
                    });
                }
            });

            const failureFactorLabels = Array.from(allFailureFactors).sort();
            const failureFactorData = failureFactorLabels.map(label => failureFactorCounts[label] || 0);

            if (failureFactorChart) {
                failureFactorChart.data.labels = failureFactorLabels;
                failureFactorChart.data.datasets[0].data = failureFactorData;
                failureFactorChart.update();
            }

            // NEW: Trade Duration Win Rate Chart
            const tradeDurationWinRates = {};
            const durationCategories = ['Day', 'Swing', 'LongTerm'];

            durationCategories.forEach(category => {
                tradeDurationWinRates[category] = { wins: 0, total: 0 };
            });

            completedTrades.forEach(trade => {
                const duration = trade.tradeDuration;
                if (duration && durationCategories.includes(duration)) {
                    tradeDurationWinRates[duration].total++;
                    if (trade.resultOutcome === '수익') {
                        tradeDurationWinRates[duration].wins++;
                    }
                }
            });

            const tradeDurationData = durationCategories.map(category => {
                if (tradeDurationWinRates[category].total > 0) {
                    return (tradeDurationWinRates[category].wins / tradeDurationWinRates[category].total * 100).toFixed(2);
                }
                return 0;
            });

            if (tradeDurationWinRateChart) {
                tradeDurationWinRateChart.data.datasets[0].data = tradeDurationData;
                tradeDurationWinRateChart.update();
            }
        }

        // Render Trade History Table
        function renderTradeHistory() {
            tradeHistoryBody.innerHTML = '';
            if (!window.trades) {
                return;
            }
            window.trades.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date descending
            window.trades.forEach(trade => {
                let holdingPeriod = '';
                if (trade.date && trade.exitDate && trade.resultOutcome !== '진행 중') {
                    const entry = new Date(trade.date);
                    const exit = new Date(trade.exitDate);
                    const diffTime = Math.abs(exit - entry);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    holdingPeriod = `${diffDays} 일`;
                } else if (trade.resultOutcome === '진행 중') {
                    holdingPeriod = '진행 중';
                }

                let displayPnl = '-';
                if (trade.pnlAmount !== null && trade.pnlAmount !== undefined) {
                    let pnlUsd = parseFloat(trade.pnlAmount);
                    const currentExchangeRate = parseFloat(document.getElementById('exchangeRateInput').value) || 1350;

                    if (trade.pnlCurrency === 'KRW') {
                        pnlUsd = pnlUsd / currentExchangeRate;
                    }
                    displayPnl = `${formatNumberWithCommas(pnlUsd.toFixed(2))} $`;
                }


                const row = document.createElement('tr');
                // Removed all Tailwind bg-white, dark:bg-gray-800, divide-gray-200, dark:divide-gray-700 classes from table and cells
                // Replaced with custom CSS for table borders and cell colors
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${trade.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${trade.exitDate || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${holdingPeriod || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${trade.stockName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${trade.tradeType}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${trade.tradeDuration || '-'}</td> <!-- NEW: Display Trade Duration -->
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${trade.resultOutcome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${trade.rRatio !== null ? trade.rRatio : '-'}</td>
                    <td class="px-6 py-4 text-sm">${Array.isArray(trade.psychology) ? trade.psychology.join(', ') : ''}</td>
                    <td class="px-6 py-4 text-sm">${Array.isArray(trade.entryBasis) ? trade.entryBasis.join(', ') : ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${displayPnl}</td> <!-- ADDED PNL DISPLAY -->
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editTrade('${trade.id}')" class="text-indigo-600 hover:text-indigo-900 ml-2 dark:text-indigo-400 dark:hover:text-indigo-200">수정</button>
                        <button onclick="showCustomConfirmationModal('정말 이 매매 기록을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.', () => deleteTrade('${trade.id}'))" class="text-red-600 hover:text-red-900 ml-2 dark:text-red-400 dark:hover:text-red-200">삭제</button>
                    </td>
                `;
                tradeHistoryBody.appendChild(row);
            });
        }

        // Function to populate form for editing
        window.editTrade = function(tradeId) {
            const tradeToEdit = window.trades.find(t => t.id === tradeId);
            if (!tradeToEdit) return;

            document.getElementById('date').value = tradeToEdit.date;
            document.getElementById('stockName').value = tradeToEdit.stockName;
            
            // Uncheck all tradeType radios first
            document.querySelectorAll('input[name="tradeType"]').forEach(radio => radio.checked = false);
            // Then check the correct one
            const tradeTypeRadio = document.querySelector(`input[name="tradeType"][value="${tradeToEdit.tradeType}"]`);
            if (tradeTypeRadio) tradeTypeRadio.checked = true;

            // NEW: Populate tradeDuration radios
            document.querySelectorAll('input[name="tradeDuration"]').forEach(radio => radio.checked = false);
            const tradeDurationRadio = document.querySelector(`input[name="tradeDuration"][value="${tradeToEdit.tradeDuration}"]`);
            if (tradeDurationRadio) tradeDurationRadio.checked = true;

            document.getElementById('entryPrice').value = tradeToEdit.entryPrice;
            document.getElementById('stopLossPrice').value = tradeToEdit.stopLossPrice || '';
            document.getElementById('targetPrice').value = tradeToEdit.targetPrice || '';
            document.getElementById('half').value = tradeToEdit.half || '';
            document.getElementById('weight').value = tradeToEdit.weight;
            document.getElementById('exitDate').value = tradeToEdit.exitDate || '';

            // Ensure all checkboxes are unchecked first, then set based on data
            document.querySelectorAll('input[name="psychology"]').forEach(cb => cb.checked = false);
            if (Array.isArray(tradeToEdit.psychology)) {
                tradeToEdit.psychology.forEach(tag => {
                    const checkbox = document.querySelector(`input[name="psychology"][value="${tag}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }

            document.querySelectorAll('input[name="entryBasis"]').forEach(cb => cb.checked = false);
            if (Array.isArray(tradeToEdit.entryBasis)) {
                tradeToEdit.entryBasis.forEach(tag => {
                    const checkbox = document.querySelector(`input[name="entryBasis"][value="${tag}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }

            // Reset and set success factors
            document.querySelectorAll('input[name="successFactor"]').forEach(cb => cb.checked = false);
            if (Array.isArray(tradeToEdit.successFactors)) {
                tradeToEdit.successFactors.forEach(factor => {
                    const checkbox = document.querySelector(`input[name="successFactor"][value="${factor}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }

            // Reset and set failure factors
            document.querySelectorAll('input[name="failureFactor"]').forEach(cb => cb.checked = false);
            if (Array.isArray(tradeToEdit.failureFactors)) {
                tradeToEdit.failureFactors.forEach(factor => {
                    const checkbox = document.querySelector(`input[name="failureFactor"][value="${factor}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }


            resultOutcomeSelect.value = tradeToEdit.resultOutcome;
            rRatioInput.value = tradeToEdit.rRatio || '';
            pnlAmountInput.value = tradeToEdit.pnlAmount || ''; // ADDED: Populate PNL amount
            // ADDED: Populate PNL currency
            if (tradeToEdit.pnlCurrency === 'USD') {
                pnlCurrencyUSD.checked = true;
            } else {
                pnlCurrencyKRW.checked = true; // Default to KRW if not set or KRW
            }

            exitReasonSelect.value = tradeToEdit.exitReason || '';


            replayQuestion1Select.value = tradeToEdit.replayQuestion1 || '';
            replayQuestion2Textarea.value = tradeToEdit.replayQuestion2 || '';
            replayQuestion3Input.value = tradeToEdit.replayQuestion3 || '';

            updateResultFieldRequirements();

            document.querySelector('#tradeForm button[type="submit"]').textContent = '매매 기록 업데이트';
            currentEditingTradeId = tradeId; // Set the ID of the trade being edited

            document.getElementById('trade-entry').scrollIntoView({ behavior: 'smooth' });
        }


        // Handle actual delete logic
        window.deleteTrade = async function(tradeId) {
            console.log(`[deleteTrade] Attempting to delete trade with ID: ${tradeId}`);
            console.log(`[deleteTrade] window.db:`, window.db);
            console.log(`[deleteTrade] window.currentUserId:`, window.currentUserId);
            console.log(`[deleteTrade] window.userTradesCollectionRef:`, window.userTradesCollectionRef);

            // Firebase DB, currentUser, userTradesCollectionRef가 모두 유효한지 확인
            if (!window.db || !window.currentUserId || !window.userTradesCollectionRef) {
                showStatusMessage('데이터베이스가 아직 준비되지 않았거나, 로그인 상태를 확인할 수 없습니다. 잠시 후 다시 시도하거나 로그인해주세요.', 'error');
                console.error("[deleteTrade] Firebase/User or collection reference not ready.");
                return;
            }

            showLoadingSpinner(); // Show loading spinner
            showStatusMessage('삭제 중...', 'info'); // Indicate deletion in progress

            try {
                // doc 함수에 userTradesCollectionRef와 tradeId를 함께 전달하여 올바른 문서 참조를 생성
                const tradeDocRef = window.doc(window.userTradesCollectionRef, tradeId);
                console.log(`[deleteTrade] Attempting to delete document at path: ${tradeDocRef.path}`); // Log the exact path
                await window.deleteDoc(tradeDocRef);
                hideLoadingSpinner(); // Hide spinner on success
                showStatusMessage('매매 기록이 성공적으로 삭제되었습니다!', 'success');
                console.log(`[deleteTrade] Trade ${tradeId} successfully deleted.`);
                // onSnapshot 리스너가 데이터 변경을 감지하고 자동으로 UI를 업데이트하므로,
                // 여기서 별도로 renderTradeHistory()를 호출할 필요는 없습니다.
            } catch (error) {
                hideLoadingSpinner(); // Hide spinner on error
                console.error("[deleteTrade] 기록 삭제 실패:", error);
                // Check for specific error types if possible
                if (error.code === 'permission-denied') {
                    showStatusMessage(`매매 기록 삭제 실패: 권한이 없습니다. Firebase 보안 규칙을 확인해주세요.`, 'error');
                } else if (error.code === 'not-found') {
                    showStatusMessage(`매매 기록 삭제 실패: 해당 기록을 찾을 수 없습니다.`, 'error');
                } else {
                    showStatusMessage(`매매 기록 삭제 실패: ${error.message}.`, 'error');
                }
            }
        };


        // Function to update required status of result fields
        function updateResultFieldRequirements() {
            const isCompleted = resultOutcomeSelect.value !== '진행 중';

            rRatioInput.required = isCompleted;
            pnlAmountInput.required = isCompleted; // ADDED: PNL input required
            pnlCurrencyKRW.required = isCompleted; // Make currency required too
            pnlCurrencyUSD.required = isCompleted; // Make currency required too
            exitReasonSelect.required = isCompleted;
            replayQuestion1Select.required = isCompleted;

            rRatioInput.placeholder = isCompleted ? "예: 1.5 (수익), 0.8 (손절)" : "진행 중인 매매는 선택 사항";
            pnlAmountInput.placeholder = isCompleted ? "예: 50.00 (수익), -25.50 (손실)" : "진행 중인 매매는 선택 사항"; // ADDED: PNL placeholder
            exitReasonSelect.querySelector('option[value=""]').textContent = isCompleted ? "선택하세요" : "진행 중인 매매는 선택 사항";
            replayQuestion1Select.querySelector('option[value=""]').textContent = isCompleted ? "선택하세요" : "진행 중인 매매는 선택 사항";

            if (!isCompleted && currentEditingTradeId === null) {
                rRatioInput.value = '';
                pnlAmountInput.value = ''; // ADDED: Clear PNL input
                pnlCurrencyKRW.checked = true; // Default to KRW for new entries
                pnlCurrencyUSD.checked = false;
                exitReasonSelect.value = '';
                replayQuestion1Select.value = '';
                replayQuestion2Textarea.value = '';
                replayQuestion3Input.value = '';
                document.querySelectorAll('input[name="successFactor"]').forEach(cb => cb.checked = false); // 성공 요인 초기화
                document.querySelectorAll('input[name="failureFactor"]').forEach(cb => cb.checked = false); // 실패 요인 초기화
            }
        }

        // Event listener for resultOutcome change
        resultOutcomeSelect.addEventListener('change', updateResultFieldRequirements);

        // Handle Form Submission
        tradeForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            if (!window.db || !window.currentUserId || !window.userTradesCollectionRef) {
                showStatusMessage('데이터베이스가 아직 준비되지 않았거나, 로그인 상태를 확인할 수 없습니다. 잠시 후 다시 시도하거나 로그인해주세요.', 'error');
                return;
            }

            showLoadingSpinner();
            showStatusMessage('저장 중...', 'info');

            const tradeData = {
                date: document.getElementById('date').value,
                stockName: document.getElementById('stockName').value,
                tradeType: document.querySelector('input[name="tradeType"]:checked').value,
                tradeDuration: document.querySelector('input[name="tradeDuration"]:checked').value, // NEW: Add tradeDuration
                entryPrice: parseFloat(document.getElementById('entryPrice').value),
                stopLossPrice: parseFloat(document.getElementById('stopLossPrice').value) || null,
                targetPrice: parseFloat(document.getElementById('targetPrice').value) || null,
                half: parseFloat(document.getElementById('half').value) || null,
                weight: parseFloat(document.getElementById('weight').value),
                exitDate: document.getElementById('exitDate').value || null,
                psychology: Array.from(document.querySelectorAll('input[name="psychology"]:checked')).map(cb => cb.value),
                entryBasis: Array.from(document.querySelectorAll('input[name="entryBasis"]:checked')).map(cb => cb.value),
                resultOutcome: resultOutcomeSelect.value,
                rRatio: parseFloat(rRatioInput.value) || null,
                pnlAmount: parseFloat(pnlAmountInput.value) || null, // ADDED: pnlAmount to tradeData
                pnlCurrency: document.querySelector('input[name="pnlCurrency"]:checked')?.value || 'KRW', // ADDED: pnlCurrency
                exitReason: exitReasonSelect.value || null,
                successFactors: Array.from(document.querySelectorAll('input[name="successFactor"]:checked')).map(cb => cb.value), // 성공 요인 저장
                failureFactors: Array.from(document.querySelectorAll('input[name="failureFactor"]:checked')).map(cb => cb.value), // 실패 요인 저장
                replayQuestion1: replayQuestion1Select.value || null,
                replayQuestion2: replayQuestion2Textarea.value || null,
                replayQuestion3: parseInt(replayQuestion3Input.value) || null,
                timestamp: Date.now() // 최신순 정렬을 위한 타임스탬프
            };

            try {
                if (currentEditingTradeId) {
                    // 기존 매매 업데이트: updateDoc 사용
                    await window.updateDoc(window.doc(window.userTradesCollectionRef, currentEditingTradeId), tradeData);
                    showStatusMessage('매매 기록이 업데이트되었습니다!', 'success');
                } else {
                    // 새로운 매매 추가: addDoc 사용 (Firestore가 ID를 자동 생성)
                    await window.addDoc(window.userTradesCollectionRef, tradeData);
                    showStatusMessage('새로운 매매 기록이 저장되었습니다!', 'success');
                }
                tradeForm.reset(); // Clear form after submission
                document.getElementById('date').value = new Date().toISOString().split('T')[0]; // Reset date to today
                document.getElementById('exitDate').value = ''; // Clear exit date
                pnlCurrencyKRW.checked = true; // Reset currency to default KRW
                pnlCurrencyUSD.checked = false;
                // NEW: Reset trade duration radios
                document.getElementById('tradeDurationDay').checked = true; // Default to Day
                document.getElementById('tradeDurationSwing').checked = false;
                document.getElementById('tradeDurationLongTerm').checked = false;

                currentEditingTradeId = null; // Reset editing state
                document.querySelector('#tradeForm button[type="submit"]').textContent = '매매 기록 저장'; // Reset button text

                // 데이터는 onSnapshot을 통해 자동으로 업데이트되므로, 직접 렌더링/대시보드 업데이트 불필요
            } catch (error) {
                console.error("매매 기록 저장/업데이트 실패:", error);
                showStatusMessage('매매 기록 저장/업데이트 실패: ' + error.message + '. Firebase 콘솔에서 보안 규칙과 로그인 상태를 확인해주세요.', 'error');
            } finally {
                hideLoadingSpinner();
            }
        });

        // Report related logic
        const reportPeriodRadios = document.querySelectorAll('input[name="reportPeriod"]');
        
        // Event listener for report period radios
        reportPeriodRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                const selectedType = document.querySelector('input[name="reportPeriod"]:checked').value;
                if (selectedType === 'monthly') {
                    reportMonthSelector.classList.remove('hidden');
                    // Set default month to current if switching to monthly
                    const today = new Date();
                    reportMonthSelector.value = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
                } else { // quarterly
                    reportMonthSelector.classList.remove('hidden'); // Keep month selector visible
                    // The month selector will be used to determine the quarter.
                }
                updateReports(); // Update reports after changing period type
            });
        });


        function updateReports() {
            if (!window.trades || window.trades.length === 0) {
                document.getElementById('reportTotalTrades').textContent = formatNumberWithCommas(0);
                document.getElementById('reportWinRate').textContent = '0.00%';
                document.getElementById('reportAvgRR').textContent = formatNumberWithCommas(0);
                document.getElementById('reportTotalUSDPNL').textContent = '0.00 $'; // Updated ID
                document.getElementById('reportTotalKRWPNL').textContent = '0.00 ₩'; // Updated ID
                return;
            }

            const selectedPeriodType = document.querySelector('input[name="reportPeriod"]:checked').value;
            let filteredTrades = [];
            const selectedDate = reportMonthSelector.value;
            const currentExchangeRate = parseFloat(document.getElementById('exchangeRateInput').value) || 1350; // Get rate from input, default to 1350

            if (!selectedDate) { // Handle case where month input is empty
                filteredTrades = [];
            } else {
                const [year, month] = selectedDate.split('-');
                if (selectedPeriodType === 'monthly') {
                    filteredTrades = window.trades.filter(trade => {
                        const tradeDate = new Date(trade.date);
                        return tradeDate.getFullYear() === parseInt(year) && (tradeDate.getMonth() + 1) === parseInt(month);
                    });
                } else if (selectedPeriodType === 'quarterly') {
                    const currentMonth = parseInt(month);
                    const quarter = Math.floor((currentMonth - 1) / 3) + 1; // 1-4
                    
                    filteredTrades = window.trades.filter(trade => {
                        const tradeDate = new Date(trade.date);
                        const tradeQuarter = Math.floor((tradeDate.getMonth()) / 3) + 1;
                        return tradeDate.getFullYear() === parseInt(year) && tradeQuarter === quarter;
                    });
                }
            }
            

            const completedFilteredTrades = filteredTrades.filter(t => t.resultOutcome !== '진행 중');

            const totalTrades = completedFilteredTrades.length;
            const winTrades = completedFilteredTrades.filter(t => t.resultOutcome === '수익').length;
            const totalRR = completedFilteredTrades.reduce((sum, t) => sum + (parseFloat(t.rRatio) || 0), 0);
            
            let totalUSDPNL = 0;
            let totalKRWPNL = 0;

            completedFilteredTrades.forEach(trade => {
                const pnlAmount = parseFloat(trade.pnlAmount) || 0;
                const pnlCurrency = trade.pnlCurrency || 'KRW'; // Default to KRW

                if (pnlCurrency === 'KRW') {
                    totalKRWPNL += pnlAmount;
                    totalUSDPNL += (pnlAmount / currentExchangeRate); // Use dynamic rate
                } else if (pnlCurrency === 'USD') {
                    totalUSDPNL += pnlAmount;
                    totalKRWPNL += (pnlAmount * currentExchangeRate); // Use dynamic rate
                }
            });


            document.getElementById('reportTotalTrades').textContent = formatNumberWithCommas(totalTrades);
            document.getElementById('reportWinRate').textContent = `${totalTrades > 0 ? (winTrades / totalTrades * 100).toFixed(2) : 0.00}%`;
            document.getElementById('reportAvgRR').textContent = formatNumberWithCommas(totalTrades > 0 ? (totalRR / totalTrades).toFixed(2) : 0.00);
            document.getElementById('reportTotalUSDPNL').textContent = `${formatNumberWithCommas(totalUSDPNL.toFixed(2))} $`; // Format with USD
            document.getElementById('reportTotalKRWPNL').textContent = `${formatNumberWithCommas(totalKRWPNL.toFixed(2))} ₩`; // Format with KRW
        }

    </script>
    <style>
        /* 다크 모드 스타일 */
        :root {
            --bg-primary: #f8f5f2; /* Light background */
            --bg-secondary: #ffffff; /* Card/Container background */
            --bg-tertiary: #f3f0ed; /* Section/Hover background */
            --text-primary: #333; /* Main text color */
            --text-secondary: #555; /* Label/Muted text color */
            --text-heading: #1a202c; /* Heading color */
            --text-link: #6a994e; /* Primary accent color */
            --border-color: #ddd; /* General border color */
            --shadow-color: rgba(0, 0, 0, 0.05); /* Soft shadow */
            --input-bg: #fff; /* Input field background */
            --input-border: #ddd; /* Input field border */
            --button-primary-bg: #6a994e;
            --button-primary-hover: #5a8542;
            --button-secondary-bg: #f0ad4e;
            --button-secondary-hover: #ec971f;
            --button-danger-bg: #d9534f;
            --button-danger-hover: #c9302c;
            --chart-bg: #ffffff;
            --chart-grid-color: rgba(0, 0, 0, 0.1);
            --table-header-bg: #e5e7eb; /* gray-100 */
            --table-border-color: #e5e7eb; /* gray-200 */
            --table-hover-bg: #f3f4f6; /* gray-50 */
        }

        .dark-mode {
            --bg-primary: #000000; /* Pure black for body background */
            --bg-secondary: #1a1a1a; /* Very dark grey for main content areas (cards, sections, header) */
            --bg-tertiary: #2a2a2a; /* Slightly lighter dark grey for sub-sections/hover/table header */
            --text-primary: #f0f0f0; /* Very light grey text */
            --text-secondary: #cccccc; /* Slightly darker light grey for labels, muted text */
            --text-heading: #ffffff; /* Pure white for headings */
            --text-link: #98ee2c; /* A vibrant green for links/accents in dark mode */

            --border-color: var(--bg-secondary); /* Border color matching section background for invisibility */
            --shadow-color: rgba(0, 0, 0, 0.9); /* More prominent shadows */
            --input-bg: var(--bg-tertiary); /* Dark input field background */
            --input-border: var(--bg-tertiary); /* Input border matching input background for invisibility */
            --button-primary-bg: #6a994e; /* Buttons remain vibrant */
            --button-primary-hover: #5a8542;
            --button-secondary-bg: #f0ad4e;
            --button-secondary-hover: #ec971f;
            --button-danger-bg: #d9534f;
            --button-danger-hover: #c9302c;
            --chart-bg: var(--bg-secondary); /* Chart background same as secondary */
            --chart-grid-color: rgba(255, 255, 255, 0.2); /* More visible grid for dark mode */
            --table-header-bg: var(--bg-tertiary); /* Table header same as tertiary */
            --table-border-color: var(--bg-secondary); /* Table border matching table body background for invisibility */
            --table-hover-bg: var(--bg-tertiary); /* Table hover same as tertiary */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        /* Added max-width and margin auto for centering */
        .container {
            max-width: 1024px; /* Adjust as needed, e.g., max-w-5xl, max-w-7xl */
            margin-left: auto;
            margin-right: auto;
            /* Removed bg-white from here, will be controlled by var(--bg-secondary) */
            background-color: var(--bg-secondary); /* Now correctly uses the variable */
            box-shadow: 0 4px 6px var(--shadow-color);
            border-radius: 0.75rem; /* Ensure container also has rounded corners */
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        section { /* General section styling for background and shadows */
            background-color: var(--bg-secondary); /* Changed to secondary for consistency */
            box-shadow: 0 4px 6px var(--shadow-color); /* Added box-shadow for a lifted effect */
            border-radius: 0.75rem; /* Rounded corners */
            padding: 1.5rem; /* Consistent padding */
            margin-bottom: 2.5rem; /* Consistent spacing */
            border: 1px solid var(--border-color); /* Added explicit border to sections */
            transition: background-color 0.3s, box-shadow 0.3s, border-color 0.3s;
        }
        header {
            background-color: var(--bg-secondary); /* Ensure header also respects dark mode */
            transition: background-color 0.3s;
        }
        h1, h2, h3 {
            color: var(--text-heading);
            transition: color 0.3s;
        }
        h4 { /* Specific style for subheadings in sections */
            color: var(--text-secondary); /* Default for light mode */
            transition: color 0.3s;
        }
        .dark-mode h4 { /* Override for dark mode subheadings */
            color: var(--text-heading); /* Make them bright in dark mode */
        }
        p {
            color: var(--text-secondary);
            transition: color 0.3s;
        }
        /* Adjusted label color for better dark mode visibility, especially for checkboxes */
        label {
            color: var(--text-secondary);
            transition: color 0.3s;
        }
        .dark-mode label {
            color: var(--text-secondary); /* Overridden by specific dark:text-gray-300 on element */
        }
        .chart-container {
            background-color: var(--chart-bg);
            box-shadow: 0 4px 6px var(--shadow-color);
            border: 1px solid var(--border-color); /* Add border for charts */
            transition: background-color 0.3s, box-shadow 0.3s, border-color 0.3s;
            height: 320px; /* Fixed height for charts to control size */
            display: flex; /* Use flex to center content vertically */
            flex-direction: column; /* Stack title/description above canvas */
            justify-content: flex-start; /* Align content to start */
            align-items: center; /* Center horizontally */
            padding: 1rem; /* Add some padding inside the chart container */
        }
        .chart-container h3, .chart-container p {
            margin-bottom: 0.5rem; /* Space between title, description, and chart */
            text-align: center; /* Ensure title/description are centered */
        }
        .chart-container canvas {
            max-height: calc(100% - 3rem); /* Adjust based on title/p height, roughly */
            max-width: 100%; /* Ensure canvas doesn't overflow its container */
        }
        .input-group label {
            color: var(--text-secondary);
        }
        .input-group input[type="text"],
        .input-group input[type="number"],
        .input-group select,
        .input-group textarea,
        .input-group input[type="date"] {
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--text-primary);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.03);
            transition: border-color 0.3s, background-color 0.3s, color 0.3s;
        }
        .input-group input[type="text"]:focus,
        .input-group input[type="number"]:focus,
        .input-group select:focus,
        .input-group textarea:focus,
        .input-group input[type="date"]:focus {
            outline: none;
            border-color: var(--text-link); /* Accent link color */
            box-shadow: 0 0 0 3px rgba(152, 238, 44, 0.2); /* A light green shadow for focus */
        }
        .btn-primary {
            background-color: var(--button-primary-bg);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.1s, color 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* Add shadow */
        }
        .btn-primary:hover {
            background-color: var(--button-primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .btn-danger {
            background-color: var(--button-danger-bg);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.1s, color 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .btn-danger:hover {
            background-color: var(--button-danger-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .btn-danger:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .btn-secondary {
            background-color: var(--button-secondary-bg);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.1s, color 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .btn-secondary:hover {
            background-color: var(--button-secondary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .btn-secondary:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* Dark mode toggle button */
        #darkModeToggle {
            background-color: var(--button-primary-bg); /* Use primary button color for consistency */
            color: white;
            box-shadow: 0 2px 4px var(--shadow-color);
        }
        .dark-mode #darkModeToggle {
            background-color: var(--button-primary-bg); /* Dark mode specific button color, but kept same for consistency */
        }
        #darkModeToggle:hover {
            background-color: var(--button-primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }


        table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid var(--border-color); /* Table border */
            transition: border-color 0.3s;
        }
        th {
            background-color: var(--table-header-bg);
            font-weight: 600;
            color: var(--text-secondary); /* Changed this from dark:text-gray-300 to dynamic variable */
            transition: background-color 0.3s, color 0.3s;
        }
        .dark-mode th {
            color: var(--text-primary); /* Ensure table headers are visible in dark mode */
        }
        td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--table-border-color); /* Use custom variable for border-bottom */
            color: var(--text-primary); /* This will be #f0f0f0 in dark mode */
            transition: border-color 0.3s, color 0.3s;
        }
        tr:hover {
            background-color: var(--table-hover-bg);
            transition: background-color 0.3s;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.9); /* More opaque black for modal overlay */
        }
        .modal-content {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            box-shadow: 0 8px 16px var(--shadow-color);
            transition: background-color 0.3s, color 0.3s, box-shadow 0.3s;
        }
        .modal-header h3 {
            color: var(--text-heading);
        }
        .modal-close {
            color: var(--text-secondary);
        }
        .modal-close:hover {
            color: var(--text-primary);
        }
        .status-message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            font-weight: 500;
            text-align: center;
            background-color: var(--bg-secondary); /* Ensure it adapts */
            color: var(--text-primary); /* Ensure it adapts */
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        /* Specific status message colors to override the general ones for error/success */
        .status-message.text-red-600 { color: #ef4444; }
        .status-message.bg-red-100 { background-color: #fee2e2; }
        .status-message.border-red-200 { border-color: #fca5a5; }
        .dark-mode .status-message.text-red-600 { color: #f87171; }
        .dark-mode .status-message.bg-red-100 { background-color: #450a0a; }
        .dark-mode .status-message.border-red-200 { border-color: #7f1d1d; }

        .status-message.text-green-600 { color: #16a34a; }
        .status-message.bg-green-100 { background-color: #dcfce7; }
        .status-message.border-green-200 { border-color: #bbf7d0; }
        .dark-mode .status-message.text-green-600 { color: #4ade80; }
        .dark-mode .status-message.bg-green-100 { background-color: #0c4323; }
        .dark-mode .status-message.border-green-200 { border-color: #15803d; }

    </style>
</head>
<body class="p-4">
    <div class="container rounded-2xl shadow-lg p-6 md:p-8"> <!-- Removed bg-white here -->
        <header class="text-center mb-8 rounded-xl p-4">
            <h1 class="text-4xl font-bold mb-2">매매 일지 및 분석 대시보드</h1>
            <p class="text-lg text-gray-700 dark:text-secondary">당신의 매매 기록을 체계적으로 관리하고 심리, 근거, 결과 간의 상관관계를 분석하세요.</p>
            <div id="authButtons" class="flex justify-center gap-4 mt-4">
                <button id="googleSignInBtn" class="bg-blue-600 text-white py-2 px-4 rounded-lg shadow hover:bg-blue-700 transition-colors hidden">
                    구글 로그인
                </button>
                <button id="signOutBtn" class="bg-red-500 text-white py-2 px-4 rounded-lg shadow hover:bg-red-600 transition-colors hidden">
                    로그아웃
                </button>
            </div>
            <div id="userIdDisplay" class="text-sm text-gray-500 mt-2 dark:text-secondary">사용자: 로딩 중...</div>
            <button id="darkModeToggle" class="mt-4 py-2 px-4 rounded-lg shadow">
                다크 모드 토글
            </button>
        </header>

        <div id="statusMessage" class="status-message hidden"></div>
        <div id="loadingSpinner" class="loading-spinner mx-auto hidden"></div>

        <section id="trade-entry" class="rounded-xl shadow p-6 mb-10">
            <h2 class="text-2xl font-semibold mb-6">새로운 매매 기록하기</h2>
            <p class="text-sm mb-6">이 섹션에서 당신의 매매에 대한 모든 세부 정보를 입력할 수 있습니다. 각 필드를 채우고, 해당되는 심리 태그와 진입 근거를 선택한 다음, 매매 결과를 기록하여 당신의 트레이딩 데이터를 축적하세요. 이미 기록된 매매를 수정하려면 아래 '매매 기록 히스토리'에서 '수정' 버튼을 클릭하세요.</p>

            <form id="tradeForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- 1. 기본정보 -->
                <div class="col-span-full">
                    <h3 class="text-xl font-medium mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">1. 기본 정보</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="input-group">
                            <label for="date" class="block text-sm mb-1">진입 날짜</label>
                            <input type="date" id="date" class="w-full rounded-md p-2">
                        </div>
                        <div class="input-group">
                            <label for="stockName" class="block text-sm mb-1">종목명</labe>
                            <input type="text" id="stockName" class="w-full rounded-md p-2" placeholder="예: 삼성전자" required>
                        </div>
                        <div class="input-group flex items-center space-x-4">
                            <label class="text-sm">유형</label>
                            <div class="flex items-center">
                                <input type="radio" id="buy" name="tradeType" value="매수" class="mr-2" required>
                                <label for="buy" class="text-sm">매수</label>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" id="sell" name="tradeType" value="매도" class="mr-2">
                                <label for="sell" class="text-sm">매도</label>
                            </div>
                        </div>
                        <!-- NEW: Trade Duration Buttons -->
                        <div class="input-group flex items-center space-x-4">
                            <label class="text-sm">매매 기간</label>
                            <div class="flex items-center">
                                <input type="radio" id="tradeDurationDay" name="tradeDuration" value="Day" class="mr-2" required>
                                <label for="tradeDurationDay" class="text-sm">데이</label>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" id="tradeDurationSwing" name="tradeDuration" value="Swing" class="mr-2">
                                <label for="tradeDurationSwing" class="text-sm">스윙</label>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" id="tradeDurationLongTerm" name="tradeDuration" value="LongTerm" class="mr-2">
                                <label for="tradeDurationLongTerm" class="text-sm">장기</label>
                            </div>
                        </div>
                        <!-- END NEW: Trade Duration Buttons -->
                        <div class="input-group">
                            <label for="entryPrice" class="block text-sm mb-1">진입가</label>
                            <input type="number" id="entryPrice" class="w-full rounded-md p-2" step="0.000001" placeholder="예: 123.456789" required>
                        </div>
                        <div class="input-group">
                            <label for="stopLossPrice" class="block text-sm mb-1">손절가</label>
                            <input type="number" id="stopLossPrice" class="w-full rounded-md p-2" step="0.000001" placeholder="예: 120.000000">
                        </div>
                        <div class="input-group">
                            <label for="targetPrice" class="block text-sm mb-1">목표가</label>
                            <input type="number" id="targetPrice" class="w-full rounded-md p-2" step="0.000001" placeholder="예: 130.000000">
                        </div>
                        <div class="input-group">
                            <label for="half" class="block text-sm mb-1">하프 (부분 익절/손절 지점)</label>
                            <input type="number" id="half" class="w-full rounded-md p-2" step="0.000001" placeholder="선택 사항">
                        </div>
                        <div class="input-group">
                            <label for="weight" class="block text-sm mb-1">비중 (%)</label>
                            <input type="number" id="weight" class="w-full rounded-md p-2" step="0.1" placeholder="예: 10.5" required>
                        </div>
                    </div>
                </div>

                <!-- 2. 심리 태그 -->
                <div class="col-span-full">
                    <h3 class="text-xl font-medium mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">2. 심리 태그</h3>
                    <p class="text-sm mb-4">매매 당시의 당신의 심리 상태를 가장 잘 나타내는 태그들을 선택하세요.</p>
                    <div id="psychologyCheckboxes" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-2">
                        <!-- Psychology checkboxes will be rendered here by JavaScript -->
                    </div>
                </div>

                <!-- 3. 진입근거 -->
                <div class="col-span-full">
                    <h3 class="text-xl font-medium mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">3. 진입 근거</h3>
                    <p class="text-sm mb-4">매매 진입 시 사용했거나 고려했던 신호 기반의 근거들을 선택하세요.</p>
                    <div id="entryBasisCheckboxes" class="checkbox-group grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-2">
                        <!-- Entry Basis checkboxes will be rendered here by JavaScript -->
                    </div>
                </div>

                <!-- 4. 결과 -->
                <div class="col-span-full">
                    <h3 class="text-xl font-medium mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">4. 결과</h3>
                    <p class="text-sm mb-4">매매의 최종 결과와 그 원인을 진단하고, 리플레이 질문에 답변하여 다음 매매에 도움이 되는 통찰을 얻으세요.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="input-group">
                            <label for="resultOutcome" class="block text-sm mb-1">A. 매매 결과 요약: 결과</label>
                            <select id="resultOutcome" class="w-full rounded-md p-2">
                                <option value="">선택하세요</option>
                                <option value="수익">수익</option>
                                <option value="손절">손절</option>
                                <option value="본절">본절</option>
                                <option value="진행 중">진행 중</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="rRatio" class="block text-sm mb-1">손익비 (R-Ratio)</label>
                            <input type="number" id="rRatio" class="w-full rounded-md p-2" step="0.01" placeholder="예: 1.5 (수익), 0.8 (손절)">
                        </div>
                        <div class="input-group">
                            <label for="pnlAmount" class="block text-sm mb-1">순손익 (PNL)</label>
                            <div class="flex items-center">
                                <input type="number" id="pnlAmount" class="w-full rounded-md p-2 mr-2" step="0.01" placeholder="예: 50.00 (수익), -25.50 (손실)">
                                <div class="flex items-center space-x-2">
                                    <input type="radio" id="pnlCurrencyKRW" name="pnlCurrency" value="KRW" class="mr-1" checked>
                                    <label for="pnlCurrencyKRW" class="text-sm">원</label>
                                    <input type="radio" id="pnlCurrencyUSD" name="pnlCurrency" value="USD" class="mr-1">
                                    <label for="pnlCurrencyUSD" class="text-sm">달러</label>
                                </div>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="exitDate" class="block text-sm mb-1">청산 날짜</label>
                            <input type="date" id="exitDate" class="w-full rounded-md p-2">
                        </div>
                        <div class="input-group col-span-full">
                            <label for="exitReason" class="block text-sm mb-1">청산 이유</label>
                            <select id="exitReason" class="w-full rounded-md p-2">
                                <option value="">선택하세요</option>
                                <option value="계획 청산">계획 청산</option>
                                <option value="감정 청산">감정 청산</option>
                                <option value="급변 대응">급변 대응</option>
                                <option value="목표 도달 전 청산">목표 도달 전 청산</option>
                            </select>
                        </div>

                        <!-- B. 성공 및 실패 요인 진단 - New Wrapper -->
                        <div class="col-span-full">
                            <h3 class="text-xl font-medium mb-4 mt-6 border-b pb-2 border-gray-200 dark:border-gray-700">B. 성공 및 실패 요인 진단</h3>
                            <p class="text-sm mb-4">매매의 성공 또는 실패에 기여한 요인들을 진단합니다. 해당되는 태그를 선택하세요.</p>
                            
                            <!-- b-1 성공 요인 진단 (Dynamic content only) -->
                            <div class="checkbox-group mb-4 grid grid-cols-1 sm:grid-cols-2 gap-2"> 
                                <div id="successFactorsCheckboxes" class="contents"> 
                                    <!-- Success factors will be dynamically inserted here by JS -->
                                </div>
                            </div>

                            <!-- b-2 실패 요인 진단 (Dynamic content only) -->
                            <div class="checkbox-group grid grid-cols-1 sm:grid-cols-2 gap-2"> 
                                <div id="failureFactorsCheckboxes" class="contents"> 
                                    <!-- Failure factors will be dynamically inserted here by JS -->
                                </div>
                            </div>
                        </div>

                        <div class="input-group col-span-full">
                            <h4 class="font-medium mb-2 mt-6">C. 리플레이 질문</h4>
                            <label for="replayQuestion1" class="block text-sm mb-1">이번 매매를 다시 한다면 똑같이 했을까?</label>
                            <select id="replayQuestion1" class="w-full rounded-md p-2">
                                <option value="">선택하세요</option>
                                <option value="예">예</option>
                                <option value="아니오">아니오</option>
                            </select>
                        </div>
                        <div class="input-group col-span-full">
                            <label for="replayQuestion2" class="block text-sm mb-1">감정이 개입된 순간은 언제였나?</label>
                            <textarea id="replayQuestion2" class="w-full h-20 rounded-md p-2" placeholder="자유롭게 작성하세요"></textarea>
                        </div>
                        <div class="input-group col-span-full">
                            <label for="replayQuestion3" class="block text-sm mb-1">운의 요소는 얼마나 있었나 (0~100%)?</label>
                            <input type="number" id="replayQuestion3" class="w-full rounded-md p-2" min="0" max="100" placeholder="0~100 사이 숫자">
                        </div>
                    </div>
                </div>

                <div class="col-span-full text-center mt-6">
                    <button type="submit" class="btn-primary">매매 기록 저장</button>
                </div>
            </form>
        </section>

        <section id="tag-management" class="rounded-xl shadow p-6 mb-10">
            <h2 class="text-2xl font-semibold mb-6">태그 관리</h2>
            <p class="text-sm mb-6">매매 기록에 사용할 심리 태그와 진입 근거를 직접 추가하거나 삭제할 수 있습니다. 추가된 태그는 모든 매매 기록에 즉시 반영됩니다.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-xl font-medium mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">심리 태그 관리</h3>
                    <div class="flex mb-4">
                        <input type="text" id="newPsychologyTag" class="w-full p-2 border rounded-md mr-2" placeholder="새 심리 태그 추가">
                        <button onclick="addCustomTag('psychology')" class="btn-primary flex-shrink-0">추가</button>
                    </div>
                    <div id="psychologyTagsDisplay" class="flex flex-wrap gap-2">
                        <!-- Custom psychology tags will be rendered here -->
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-medium mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">진입 근거 관리</h3>
                    <div class="flex mb-4">
                        <input type="text" id="newEntryBasisTag" class="w-full p-2 border rounded-md mr-2" placeholder="새 진입 근거 추가">
                        <button onclick="addCustomTag('entryBasis')" class="btn-primary flex-shrink-0">추가</button>
                    </div>
                    <div id="entryBasisTagsDisplay" class="flex flex-wrap gap-2">
                        <!-- Custom entry basis tags will be rendered here -->
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-medium mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">성공 요인 태그 관리</h3>
                    <div class="flex mb-4">
                        <input type="text" id="newSuccessFactorsTag" class="w-full p-2 border rounded-md mr-2" placeholder="새 성공 요인 태그 추가">
                        <button onclick="addCustomTag('successFactors')" class="btn-primary flex-shrink-0">추가</button>
                    </div>
                    <div id="successFactorsTagsDisplay" class="flex flex-wrap gap-2">
                        <!-- Custom success factors tags will be rendered here -->
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-medium mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">실패 요인 태그 관리</h3>
                    <div class="flex mb-4">
                        <input type="text" id="newFailureFactorsTag" class="w-full p-2 border rounded-md mr-2" placeholder="새 실패 요인 태그 추가">
                        <button onclick="addCustomTag('failureFactors')" class="btn-primary flex-shrink-0">추가</button>
                    </div>
                    <div id="failureFactorsTagsDisplay" class="flex flex-wrap gap-2">
                        <!-- Custom failure factors tags will be rendered here -->
                    </div>
                </div>
            </div>
        </section>

        <section id="trade-history" class="rounded-xl shadow p-6 mb-10">
            <h2 class="text-2xl font-semibold mb-6">매매 기록 히스토리</h2>
            <p class="text-sm mb-6">여기에 당신이 기록한 모든 매매 내역이 최신순으로 표시됩니다. 각 매매의 주요 정보를 한눈에 확인하고, 전체적인 흐름을 파악할 수 있습니다. '수정' 버튼을 클릭하여 진행 중인 매매를 업데이트하거나 완료할 수 있습니다.</p>
            <div class="overflow-x-auto rounded-lg"> <!-- Removed Tailwind borders and custom border will be applied below -->
                <table class="min-w-full">
                    <thead class="bg-gray-100 dark:bg-gray-800">
                        <tr>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300">진입 날짜</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300">청산 날짜</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300">보유 기간</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300">종목명</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300">유형</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300">매매 기간</th> <!-- NEW TH -->
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300">결과</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300">손익비</th>
                            <th class="px-6 py-4 text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300">심리 태그</th>
                            <th class="px-6 py-4 text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300">진입 근거</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300">순손익 (USD)</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-300">액션</th>
                        </tr>
                    </thead>
                    <tbody id="tradeHistoryBody">
                        <!-- Trade entries will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </section>

        <section id="analysis-dashboard" class="rounded-xl shadow p-6 mb-10">
            <h2 class="text-2xl font-semibold mb-6">매매 분석 대시보드</h2>
            <p class="text-sm mb-6">기록된 매매 데이터를 바탕으로 당신의 트레이딩 패턴과 심리, 진입 근거의 영향을 시각적으로 분석합니다. 차트를 통해 어떤 요소들이 당신의 매매 결과에 영향을 미치는지 파악하고 개선점을 찾을 수 있습니다.</p>

            <div class="grid grid-cols-1 gap-8"> <!-- Changed to single column grid -->
                <!-- Overall Performance -->
                <div class="rounded-xl shadow p-6 flex flex-col items-center justify-center text-center">
                    <h3 class="text-xl font-medium mb-4">전체 매매 성과 요약</h3>
                    <p class="text-sm mb-4">당신의 전체 매매 기록에 대한 핵심 지표를 확인하세요.</p>
                    <div class="flex flex-col sm:flex-row gap-6 text-2xl font-bold">
                        <div>
                            <span id="totalTrades" class="text-blue-600 dark:text-blue-400">0</span> <span class="text-lg text-gray-600 dark:text-gray-400">총 매매</span>
                        </div>
                        <div>
                            <span id="winRate" class="text-green-600 dark:text-green-400">0.00%</span> <span class="text-lg text-gray-600 dark:text-gray-400">승률</span>
                        </div>
                        <div>
                            <span id="avgRR" class="text-purple-600 dark:text-purple-400">0.00</span> <span class="text-lg text-gray-600 dark:text-gray-400">평균 손익비</span>
                        </div>
                    </div>
                </div>

                <!-- Result Breakdown Chart -->
                <div class="chart-container">
                    <h3 class="text-xl font-medium mb-4 text-center">매매 결과 분포</h3>
                    <p class="text-sm mb-4 text-center">수익, 손절, 본절 매매의 비율을 파악하여 당신의 매매 성향을 이해합니다.</p>
                    <canvas id="resultBreakdownChart"></canvas>
                </div>

                <!-- Psychology Impact Chart -->
                <div class="chart-container">
                    <h3 class="text-xl font-medium mb-4 text-center">심리 태그별 승률</h3>
                    <p class="text-sm mb-4 text-center">각 심리 상태가 당신의 매매 승률에 어떤 영향을 미치는지 시각적으로 확인하세요.</p>
                    <canvas id="psychologyImpactChart"></canvas>
                </div>

                <!-- Entry Basis Effectiveness Chart -->
                <div class="chart-container">
                    <h3 class="text-xl font-medium mb-4 text-center">진입 근거별 승률</h3>
                    <p class="text-sm mb-4 text-center">어떤 진입 근거가 가장 높은 승률을 보이는지 분석하여 전략을 개선하세요.</p>
                    <canvas id="entryBasisEffectivenessChart"></canvas>
                </div>

                <!-- NEW: Trade Duration Win Rate Chart -->
                <div class="chart-container">
                    <h3 class="text-xl font-medium mb-4 text-center">매매 기간별 승률</h3>
                    <p class="text-sm mb-4 text-center">매매 기간 (데이, 스윙, 장기)에 따른 승률을 비교합니다.</p>
                    <canvas id="tradeDurationWinRateChart"></canvas>
                </div>
                <!-- END NEW -->

                <!-- Success Factor Chart (Separated) -->
                <div class="chart-container">
                    <h3 class="text-xl font-medium mb-4 text-center">성공 요인 분석</h3>
                    <p class="text-sm mb-4 text-center">매매 성공에 기여한 주요 요인들의 빈도를 보여줍니다.</p>
                    <canvas id="successFactorChart"></canvas>
                </div>

                <!-- Failure Factor Chart (Separated) -->
                <div class="chart-container">
                    <h3 class="text-xl font-medium mb-4 text-center">실패 요인 분석</h3>
                    <p class="text-sm mb-4 text-center">매매 실패에 영향을 미친 주요 요인들의 빈도를 보여줍니다.</p>
                    <canvas id="failureFactorChart"></canvas>
                </div>
            </div>
        </section>

        <!-- New Section: Performance Reports -->
        <section id="performance-reports" class="rounded-xl shadow p-6 mb-10">
            <h2 class="text-2xl font-semibold mb-6">성과 보고서</h2>
            <p class="text-sm mb-6">월별 또는 분기별로 당신의 매매 성과를 요약하여 확인하세요.</p>

            <div class="flex flex-col sm:flex-row gap-4 mb-6 items-center">
                <label class="text-base font-medium text-gray-700 dark:text-gray-300">보고서 기간 선택:</label>
                <div class="flex gap-4">
                    <label class="flex items-center text-gray-700 dark:text-gray-300">
                        <input type="radio" name="reportPeriod" value="monthly" checked class="mr-2" id="reportPeriodMonthly">
                        월별
                    </label>
                    <label class="flex items-center text-gray-700 dark:text-gray-300">
                        <input type="radio" name="reportPeriod" value="quarterly" class="mr-2" id="reportPeriodQuarterly">
                        분기별
                    </label>
                </div>
                <!-- Monthly selector (also used for quarterly as per user's latest request) -->
                <input type="month" id="reportMonthSelector" class="w-auto rounded-md p-2">

                <!-- Exchange Rate Input -->
                <div class="input-group flex items-center gap-2 ml-auto">
                    <label for="exchangeRateInput" class="text-sm font-medium whitespace-nowrap dark:text-gray-300">현재 환율 (1 USD = ? KRW):</label>
                    <input type="number" id="exchangeRateInput" class="w-24 rounded-md p-2" value="1350" step="0.01">
                </div>
            </div>

            <div id="reportDisplay" class="rounded-xl shadow p-6">
                <h3 class="text-xl font-medium mb-4">선택 기간 성과 요약</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="dark:text-gray-200"><strong>총 매매:</strong> <span id="reportTotalTrades">0</span></div>
                    <div class="dark:text-gray-200"><strong>승률:</strong> <span id="reportWinRate">0.00%</span></div>
                    <div class="dark:text-gray-200"><strong>평균 손익비:</strong> <span id="reportAvgRR">0.00</span></div>
                    <div class="dark:text-gray-200"><strong>총 달러 수익:</strong> <span id="reportTotalUSDPNL">0.00 $</span></div>
                    <div class="dark:text-gray-200"><strong>총 원화 수익:</strong> <span id="reportTotalKRWPNL">0.00 ₩</span></div>
                </div>
            </div>
        </section>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModalOverlay" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4 z-50">
        <div class="modal-content rounded-lg shadow-xl p-6 w-full max-w-sm mx-auto">
            <div class="modal-header flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">매매 기록 삭제 확인</h3>
                <button id="confirmModalClose" class="modal-close text-2xl leading-none">&times;</button>
            </div>
            <p id="confirmModalMessage" class="mb-6">정말 이 매매 기록을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.</p>
            <div class="flex justify-end gap-3">
                <button id="cancelDelete" class="btn-secondary px-4 py-2">취소</button>
                <button id="confirmActionButton" class="btn-danger px-4 py-2">삭제</button>
            </div>
        </div>
    </div>
</body>
</html>

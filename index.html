<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>매매 일지 분석 앱</title>
    <!-- PWA 관련 메타 태그 및 매니페스트 링크 -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png"> <!-- 나중에 실제 아이콘 경로로 변경 -->
    <meta name="theme-color" content="#6a994e"> <!-- 앱의 테마 색상 (상태 표시줄 등) -->

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK (v9 호환) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // 전역 변수 선언 (스코프 밖에서 접근 가능하도록)
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.currentUserId = null;
        window.userTradesCollectionRef = null;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.collection = collection;
        window.query = query;
        window.onSnapshot = onSnapshot;
        window.updateDoc = updateDoc; // updateDoc 추가
        window.arrayUnion = arrayUnion; // arrayUnion 추가
        window.arrayRemove = arrayRemove; // arrayRemove 추가

        // 사용자 정의 태그를 위한 전역 변수
        window.customPsychologyTags = [];
        window.customEntryBasisTags = [];

        // 기본 심리 태그 및 진입 근거
        const predefinedPsychologyTags = [
            "사전에 준비된 자리", "사전에 준비되지 않은 자리", "조급함", "흥분상태",
            "복수매매", "냉철함", "우울함/무기력함", "피곤함", "비이성적",
            "복구 심리", "FOMO", "오기", "'이번만은' 심리", "욕심[5%이상의 고리스크]",
            "자신감", "성급한", "불안함", "리스크 계산함", "두려움", "추세", "역추세"
        ];
        const predefinedEntryBasisTags = [
            "피보나치 채널/비율", "일목균형표 (구름, 전환선 등)", "옵션", "금리선물 확인",
            "뉴스", "지표발표", "이평선", "미증시자리"
        ];


        // Google 인증 공급자 설정
        const googleProvider = new GoogleAuthProvider();
        window.signInWithGoogle = async function() {
            try {
                // signInWithPopup을 사용하여 팝업으로 로그인
                const result = await signInWithPopup(window.auth, googleProvider);
                // 로그인이 성공하면 onAuthStateChanged 리스너가 사용자 정보를 업데이트합니다.
                console.log("Google 로그인 성공:", result.user);
            } catch (error) {
                console.error("Google 로그인 실패:", error);
                const errorMessage = error.message;
                // 사용자에게 오류 메시지 표시
                document.getElementById('statusMessage').textContent = `Google 로그인 실패: ${errorMessage}`;
                document.getElementById('statusMessage').classList.remove('hidden');
                document.getElementById('statusMessage').classList.remove('text-green-600', 'bg-green-100', 'border-green-200');
                document.getElementById('statusMessage').classList.add('text-red-600', 'bg-red-100', 'border-red-200');
            }
        };

        window.signOutUser = async function() {
            try {
                await signOut(window.auth);
                console.log("로그아웃 성공");
                // 로그아웃 성공 시 상태 메시지 초기화 및 UI 업데이트 (onAuthStateChanged에 의해 처리됨)
                document.getElementById('statusMessage').textContent = '로그아웃되었습니다.';
                document.getElementById('statusMessage').classList.remove('hidden');
                document.getElementById('statusMessage').classList.remove('text-red-600', 'bg-red-100', 'border-red-200');
                document.getElementById('statusMessage').classList.add('text-green-600', 'bg-green-100', 'border-green-200');
            } catch (error) {
                console.error("로그아웃 실패:", error);
                document.getElementById('statusMessage').textContent = `로그아웃 실패: ${error.message}`;
                document.getElementById('statusMessage').classList.remove('hidden');
                document.getElementById('statusMessage').classList.remove('text-green-600', 'bg-green-100', 'border-red-200');
                document.getElementById('statusMessage').classList.add('text-red-600', 'bg-red-100', 'border-red-200');
            }
        };


        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Canvas 환경에서 제공되는 앱 ID
        // 사용자에게 제공받은 firebaseConfig를 직접 추가합니다.
        const firebaseConfig = {
          apiKey: "AIzaSyDtbBNTsYJGIJIrj-V9kqyXXOiHm5u43RM",
          authDomain: "future-futures-0u0.firebaseapp.com",
          projectId: "future-futures-0u0",
          storageBucket: "future-futures-0u0.firebasestorage.app",
          messagingSenderId: "591254718769",
          appId: "1:591254718769:web:45eccbfb9b6ed922fc4810",
          measurementId: "G-6RGPM8RZGG"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; // Canvas 환경에서 제공되는 초기 인증 토큰

        // Firebase 초기화 및 인증
        async function initializeFirebase() {
            if (!firebaseConfig || !firebaseConfig.projectId) {
                console.error("Firebase 초기화 실패: 'projectId'가 Firebase 설정에 제공되지 않았습니다. 환경 변수 '__firebase_config'를 확인해주세요.");
                document.getElementById('statusMessage').textContent = 'Firebase 초기화 오류: 프로젝트 ID가 누락되었습니다. 환경 설정을 확인해주세요.';
                document.getElementById('statusMessage').classList.remove('hidden');
                document.getElementById('loadingSpinner').classList.add('hidden');
                document.getElementById('statusMessage').classList.remove('text-green-600', 'bg-green-100', 'border-green-200');
                document.getElementById('statusMessage').classList.add('text-red-600', 'bg-red-100', 'border-red-200');
                return; // 초기화 중단
            }

            try {
                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);

                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.currentUserId = user.uid;
                        let userIdentifier = `ID: ${user.uid}`; // 전체 UID 표시
                        if (user.isAnonymous) {
                            userIdentifier += ' - 익명';
                        } else if (user.email) {
                            userIdentifier += ` (${user.email}) - Google`;
                        }
                        document.getElementById('userIdDisplay').textContent = `사용자: ${userIdentifier}`;
                        
                        // 로그인 상태에 따라 로그인/로그아웃 버튼 표시 토글
                        document.getElementById('googleSignInBtn').classList.add('hidden');
                        document.getElementById('signOutBtn').classList.remove('hidden');

                        // 사용자 전용 컬렉션 경로 설정
                        window.userTradesCollectionRef = window.collection(window.db, `artifacts/${appId}/users/${window.currentUserId}/trades`);
                        // 사용자 정의 태그 컬렉션 경로 설정
                        window.userCustomTagsDocRef = window.doc(window.db, `artifacts/${appId}/users/${window.currentUserId}/settings/custom_tags`);
                        
                        setupRealtimeListener();
                        loadCustomTags(); // 사용자 정의 태그 로드
                        // 데이터 로딩 성공 또는 로그인 상태 변경 시 로딩 스피너 및 메시지 숨김
                        document.getElementById('loadingSpinner').classList.add('hidden');
                        document.getElementById('statusMessage').classList.add('hidden');

                    } else {
                        console.log("사용자 로그인되지 않음. 로그인 버튼 표시.");
                        // 사용자가 로그인되지 않은 경우 UI 업데이트
                        document.getElementById('userIdDisplay').textContent = '사용자: 로그인 필요';
                        document.getElementById('googleSignInBtn').classList.remove('hidden'); // 항상 보이도록
                        document.getElementById('signOutBtn').classList.add('hidden');

                        // 이전 사용자 데이터 클리어 (로그아웃 시 데이터 초기화)
                        window.trades = [];
                        window.customPsychologyTags = []; // 로그아웃 시 태그도 초기화
                        window.customEntryBasisTags = []; // 로그아웃 시 태그도 초기화
                        renderTradeHistory();
                        updateDashboard();
                        updateReports();
                        renderTagCheckboxes(); // 체크박스 초기화
                        renderTagManagementSections(); // 태그 관리 섹션 초기화

                        document.getElementById('loadingSpinner').classList.add('hidden'); // 익명 로그인 성공 시 스피너 숨김
                        document.getElementById('statusMessage').classList.add('hidden'); // 메시지 숨김
                        
                        // NOTE: For web deployment, signInAnonymously is removed from onAuthStateChanged
                        // as it conflicts with explicit Google sign-in flow and makes Google login "useless".
                        // Anonymous login will only occur if __initial_auth_token is provided by Canvas runtime
                        // or if a previous anonymous session persists.
                    }
                });

                // For Canvas runtime, try signing in with the provided token if available
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                    console.log("Canvas initial auth token login successful.");
                } else {
                    // For direct web access or if no initial token, UI waits for explicit sign-in
                    console.log("No initial auth token. Waiting for explicit user login.");
                }

            } catch (error) {
                console.error("Firebase 초기화 오류:", error);
                document.getElementById('statusMessage').textContent = 'Firebase 초기화 오류: ' + error.message;
                document.getElementById('statusMessage').classList.remove('hidden');
                document.getElementById('loadingSpinner').classList.add('hidden');
            }
        }

        // 실시간 데이터 리스너 설정
        function setupRealtimeListener() {
            if (!window.userTradesCollectionRef) {
                console.warn("userTradesCollectionRef가 아직 설정되지 않았습니다.");
                document.getElementById('statusMessage').textContent = '데이터를 불러올 수 없습니다: 사용자 컬렉션 경로가 설정되지 않았습니다.';
                document.getElementById('statusMessage').classList.remove('hidden');
                document.getElementById('statusMessage').classList.remove('text-green-600', 'bg-green-100', 'border-green-200');
                document.getElementById('statusMessage').classList.add('text-red-600', 'bg-red-100', 'border-red-200');
                document.getElementById('loadingSpinner').classList.add('hidden');
                return;
            }

            const q = window.query(window.userTradesCollectionRef);
            window.onSnapshot(q, (snapshot) => {
                const fetchedTrades = [];
                snapshot.forEach((doc) => {
                    fetchedTrades.push({ id: doc.id, ...doc.data() });
                });
                window.trades = fetchedTrades; // 전역 trades 변수 업데이트
                renderTradeHistory();
                updateDashboard();
                updateReports(); // 보고서 업데이트 추가
                document.getElementById('loadingSpinner').classList.add('hidden');
                document.getElementById('statusMessage').classList.add('hidden'); // 데이터 로드 성공 시 메시지 숨김

            }, (error) => {
                console.error("Firebase 데이터 실시간 동기화 오류:", error);
                document.getElementById('statusMessage').textContent = '데이터 동기화 오류: ' + error.message;
                document.getElementById('statusMessage').classList.remove('hidden');
                document.getElementById('statusMessage').classList.remove('text-green-600', 'bg-green-100', 'border-green-200');
                document.getElementById('statusMessage').classList.add('text-red-600', 'bg-red-100', 'border-red-200');
                document.getElementById('loadingSpinner').classList.add('hidden');
            });
        }

        // 사용자 정의 태그 로드
        async function loadCustomTags() {
            if (!window.userCustomTagsDocRef) {
                console.warn("userCustomTagsDocRef가 아직 설정되지 않았습니다.");
                return;
            }
            window.onSnapshot(window.userCustomTagsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.customPsychologyTags = data.psychologyTags || [];
                    window.customEntryBasisTags = data.entryBasisTags || [];
                } else {
                    window.customPsychologyTags = [];
                    window.customEntryBasisTags = [];
                }
                renderTagCheckboxes();
                renderTagManagementSections();
            }, (error) => {
                console.error("사용자 정의 태그 로드 실패:", error);
                document.getElementById('statusMessage').textContent = '사용자 정의 태그 로드 실패: ' + error.message;
                document.getElementById('statusMessage').classList.remove('hidden');
            });
        }

        // 사용자 정의 태그 저장
        async function saveCustomTags() {
            if (!window.userCustomTagsDocRef || !window.currentUserId) {
                document.getElementById('statusMessage').textContent = '태그 저장 실패: 로그인 상태를 확인해주세요.';
                document.getElementById('statusMessage').classList.remove('hidden');
                return;
            }
            try {
                await window.setDoc(window.userCustomTagsDocRef, {
                    psychologyTags: window.customPsychologyTags,
                    entryBasisTags: window.customEntryBasisTags
                }, { merge: true }); // 기존 필드는 유지하면서 병합
                document.getElementById('statusMessage').textContent = '태그가 성공적으로 저장되었습니다!';
                document.getElementById('statusMessage').classList.remove('hidden');
                document.getElementById('statusMessage').classList.remove('text-red-600', 'bg-red-100', 'border-red-200');
                document.getElementById('statusMessage').classList.add('text-green-600', 'bg-green-100', 'border-green-200');
            } catch (error) {
                console.error("태그 저장 실패:", error);
                document.getElementById('statusMessage').textContent = '태그 저장 실패: ' + error.message;
                document.getElementById('statusMessage').classList.remove('hidden');
                document.getElementById('statusMessage').classList.remove('text-green-600', 'bg-green-100', 'border-red-200');
                document.getElementById('statusMessage').classList.add('text-red-600', 'bg-red-100', 'border-red-200');
            }
            setTimeout(() => { document.getElementById('statusMessage').classList.add('hidden'); }, 3000);
        }

        // 태그 추가
        window.addCustomTag = async function(type) {
            const inputId = type === 'psychology' ? 'newPsychologyTag' : 'newEntryBasisTag';
            const newTagInput = document.getElementById(inputId);
            const newTag = newTagInput.value.trim();

            if (!newTag) {
                document.getElementById('statusMessage').textContent = '추가할 태그를 입력해주세요.';
                document.getElementById('statusMessage').classList.remove('hidden', 'text-green-600', 'bg-green-100', 'border-green-200');
                document.getElementById('statusMessage').classList.add('text-red-600', 'bg-red-100', 'border-red-200');
                setTimeout(() => { document.getElementById('statusMessage').classList.add('hidden'); }, 3000);
                return;
            }

            const isPsychology = type === 'psychology';
            const currentTags = isPsychology ? window.customPsychologyTags : window.customEntryBasisTags;
            const predefinedTags = isPsychology ? predefinedPsychologyTags : predefinedEntryBasisTags;

            if (predefinedTags.includes(newTag) || currentTags.includes(newTag)) {
                 document.getElementById('statusMessage').textContent = '이미 존재하거나 유효하지 않은 태그입니다.';
                 document.getElementById('statusMessage').classList.remove('hidden', 'text-green-600', 'bg-green-100', 'border-green-200');
                 document.getElementById('statusMessage').classList.add('text-red-600', 'bg-red-100', 'border-red-200');
                 setTimeout(() => { document.getElementById('statusMessage').classList.add('hidden'); }, 3000);
                 return;
            }

            if (isPsychology) {
                window.customPsychologyTags.push(newTag);
            } else {
                window.customEntryBasisTags.push(newTag);
            }
            newTagInput.value = '';
            await saveCustomTags();
            renderTagCheckboxes();
            renderTagManagementSections();
        };

        // 태그 삭제
        window.deleteCustomTag = async function(type, tag) {
            if (confirm(`'${tag}' 태그를 삭제하시겠습니까?`)) {
                if (type === 'psychology') {
                    window.customPsychologyTags = window.customPsychologyTags.filter(t => t !== tag);
                } else {
                    window.customEntryBasisTags = window.customEntryBasisTags.filter(t => t !== tag);
                }
                await saveCustomTags();
                renderTagCheckboxes();
                renderTagManagementSections();
            }
        };

        // 매매 기록 폼에 태그 체크박스 동적 렌더링
        function renderTagCheckboxes() {
            const psychologyContainer = document.getElementById('psychologyCheckboxes');
            const entryBasisContainer = document.getElementById('entryBasisCheckboxes');

            // Ensure containers exist before attempting to manipulate them
            if (!psychologyContainer || !entryBasisContainer) {
                console.error("Tag checkbox containers not found in DOM.");
                return;
            }

            psychologyContainer.innerHTML = '';
            entryBasisContainer.innerHTML = '';

            // 2-1 상태 기반 심리
            const stateBasedPsyHeader = document.createElement('h4');
            stateBasedPsyHeader.className = "font-medium text-gray-700 mb-2 dark:text-gray-400"; // Dark mode
            stateBasedPsyHeader.textContent = "2-1 상태 기반 심리 [현재의 내 심리는?]";
            psychologyContainer.appendChild(stateBasedPsyHeader);

            const stateBasedPsychology = [
                "사전에 준비된 자리", "사전에 준비되지 않은 자리", "조급함", "흥분상태",
                "복수매매", "냉철함", "우울함/무기력함", "피곤함", "비이성적"
            ];
            stateBasedPsychology.forEach(tag => {
                const label = document.createElement('label');
                label.className = "block text-gray-600 dark:text-gray-400"; // Dark mode
                label.innerHTML = `<input type="checkbox" name="psychology" value="${tag}" class="mr-2">${tag}`;
                psychologyContainer.appendChild(label);
            });

            // 2-2 일반 심리
            const generalPsyHeader = document.createElement('h4');
            generalPsyHeader.className = "font-medium text-gray-700 mb-2 mt-4 dark:text-gray-400"; // Dark mode
            generalPsyHeader.textContent = "2-2 일반 심리";
            psychologyContainer.appendChild(generalPsyHeader);

            const generalPsychology = [
                "복구 심리", "FOMO", "오기", "'이번만은' 심리", "욕심[5%이상의 고리스크]",
                "자신감", "성급한", "불안함", "리스크 계산함", "두려움", "추세", "역추세"
            ];
            generalPsychology.forEach(tag => {
                const label = document.createElement('label');
                label.className = "block text-gray-600 dark:text-gray-400"; // Dark mode
                label.innerHTML = `<input type="checkbox" name="psychology" value="${tag}" class="mr-2">${tag}`;
                psychologyContainer.appendChild(label);
            });

            // 사용자 정의 심리 태그 (Dynamic)
            if (window.customPsychologyTags.length > 0) {
                const customPsyHeader = document.createElement('h4');
                customPsyHeader.className = "font-medium text-gray-700 mb-2 mt-4 dark:text-gray-400"; // Dark mode
                customPsyHeader.textContent = "2-3 사용자 정의 심리 태그";
                psychologyContainer.appendChild(customPsyHeader);
                window.customPsychologyTags.forEach(tag => {
                    const label = document.createElement('label');
                    label.className = "block text-gray-600 dark:text-gray-400"; // Dark mode
                    label.innerHTML = `<input type="checkbox" name="psychology" value="${tag}" class="mr-2">${tag}`;
                    psychologyContainer.appendChild(label);
                });
            }


            // 3-1 신호 기반
            const signalBasedEntryHeader = document.createElement('h4');
            signalBasedEntryHeader.className = "font-medium text-gray-700 mb-2 col-span-full dark:text-gray-400"; // Dark mode
            signalBasedEntryHeader.textContent = "3-1 신호 기반";
            entryBasisContainer.appendChild(signalBasedEntryHeader);

            predefinedEntryBasisTags.forEach(tag => {
                const label = document.createElement('label');
                label.className = "block text-gray-600 dark:text-gray-400"; // Dark mode
                label.innerHTML = `<input type="checkbox" name="entryBasis" value="${tag}" class="mr-2">${tag}`;
                entryBasisContainer.appendChild(label);
            });

            // 사용자 정의 진입 근거 태그 (Dynamic)
            if (window.customEntryBasisTags.length > 0) {
                const customEntryHeader = document.createElement('h4');
                customEntryHeader.className = "font-medium text-gray-700 mb-2 mt-4 col-span-full dark:text-gray-400"; // Dark mode
                customEntryHeader.textContent = "3-2 사용자 정의 진입 근거 태그";
                entryBasisContainer.appendChild(customEntryHeader);
                window.customEntryBasisTags.forEach(tag => {
                    const label = document.createElement('label');
                    label.className = "block text-gray-600 dark:text-gray-400"; // Dark mode
                    label.innerHTML = `<input type="checkbox" name="entryBasis" value="${tag}" class="mr-2">${tag}`;
                    entryBasisContainer.appendChild(label);
                });
            }
        }

        // 태그 관리 섹션 렌더링
        function renderTagManagementSections() {
            const psychologyTagsDisplay = document.getElementById('psychologyTagsDisplay');
            const entryBasisTagsDisplay = document.getElementById('entryBasisTagsDisplay');

            // 요소가 존재하는지 확인 후 렌더링
            if (psychologyTagsDisplay) psychologyTagsDisplay.innerHTML = '';
            if (entryBasisTagsDisplay) entryBasisTagsDisplay.innerHTML = '';


            window.customPsychologyTags.forEach(tag => {
                const span = document.createElement('span');
                span.className = "inline-flex items-center bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full mr-2 mb-2 dark:bg-blue-900 dark:text-blue-200";
                span.innerHTML = `${tag} <button onclick="deleteCustomTag('psychology', '${tag}')" class="ml-1 text-blue-600 hover:text-blue-900 dark:text-blue-300 dark:hover:text-blue-500 font-bold leading-none">&times;</button>`;
                if (psychologyTagsDisplay) psychologyTagsDisplay.appendChild(span);
            });

            window.customEntryBasisTags.forEach(tag => {
                const span = document.createElement('span');
                span.className = "inline-flex items-center bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full mr-2 mb-2 dark:bg-green-900 dark:text-green-200";
                span.innerHTML = `${tag} <button onclick="deleteCustomTag('entryBasis', '${tag}')" class="ml-1 text-green-600 hover:text-green-900 dark:text-green-300 dark:hover:text-green-500 font-bold leading-none">&times;</button>`;
                if (entryBasisTagsDisplay) entryBasisTagsDisplay.appendChild(span);
            });
        }


        // Dark Mode Toggle Logic
        window.toggleDarkMode = function() {
            document.documentElement.classList.toggle('dark-mode');
            const isDarkMode = document.documentElement.classList.contains('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            updateChartColors(isDarkMode); // 차트 색상 업데이트
        };

        // 차트 색상 업데이트 함수 (다크 모드 전환 시 호출)
        function updateChartColors(isDarkMode) {
            const textColor = isDarkMode ? '#e2e8f0' : '#333'; // lightgray-200 : gray-800
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            // 공통 옵션 업데이트
            const commonScalesOptions = {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        color: textColor, // Y축 텍스트 색상
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: {
                        color: gridColor // Y축 그리드 색상
                    }
                },
                x: {
                    ticks: {
                        color: textColor, // X축 텍스트 색상
                        callback: function(value, index, values) {
                            return wrapLabel(this.getLabelForValue(value), 16);
                        },
                        autoSkip: false,
                        maxRotation: 45,
                        minRotation: 0
                    },
                    grid: {
                        color: gridColor // X축 그리드 색상
                    }
                }
            };
            
            // Result Breakdown Chart (Doughnut)
            if (resultBreakdownChart && resultBreakdownChart.options && resultBreakdownChart.options.plugins && resultBreakdownChart.options.plugins.legend && resultBreakdownChart.options.plugins.legend.labels) {
                resultBreakdownChart.options.plugins.legend.labels.color = textColor;
            }

            // Bar Charts
            if (psychologyImpactChart) {
                psychologyImpactChart.options.scales = JSON.parse(JSON.stringify(commonScalesOptions)); // 깊은 복사
            }
            if (entryBasisEffectivenessChart) {
                entryBasisEffectivenessChart.options.scales = JSON.parse(JSON.stringify(commonScalesOptions)); // 깊은 복사
            }
            

            // Factor Analysis Chart (Horizontal Bar)
            if (factorAnalysisChart) {
                factorAnalysisChart.options.scales = {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0,
                            color: textColor // X축 텍스트 색상
                        },
                        grid: {
                            color: gridColor // X축 그리드 색상
                        }
                    },
                    y: {
                        ticks: {
                            color: textColor, // Y축 텍스트 색상
                            callback: function(value, index, values) {
                                return wrapLabel(this.getLabelForValue(value), 25);
                            },
                            autoSkip: false,
                            maxRotation: 0,
                            minRotation: 0
                        },
                        grid: {
                            color: gridColor // Y축 그리드 색상
                        }
                    }
                };
            }


            // 차트 툴팁 텍스트 색상 업데이트 (Chart.js 기본값이 다크모드에 맞춰 자동으로 변경되지 않을 경우 수동 설정)
            const tooltipFontColor = isDarkMode ? '#1a202c' : '#ffffff'; // 배경에 따라 텍스트 색상 반전
            const tooltipBgColor = isDarkMode ? '#e2e8f0' : 'rgba(0, 0, 0, 0.8)'; // 배경에 따라 툴팁 배경색 반전

            [resultBreakdownChart, psychologyImpactChart, entryBasisEffectivenessChart, factorAnalysisChart].forEach(chart => {
                if (chart && chart.options && chart.options.plugins && chart.options.plugins.tooltip) {
                    chart.options.plugins.tooltip.titleColor = tooltipFontColor;
                    chart.options.plugins.tooltip.bodyColor = tooltipFontColor;
                    chart.options.plugins.tooltip.backgroundColor = tooltipBgColor;
                    // 툴팁 보더 색상 (선택 사항)
                    chart.options.plugins.tooltip.borderColor = isDarkMode ? '#6a994e' : '#5a8542';
                    chart.options.plugins.tooltip.borderWidth = 1;
                }
            });

            // 모든 차트 업데이트
            if (resultBreakdownChart) resultBreakdownChart.update();
            if (psychologyImpactChart) psychologyImpactChart.update();
            if (entryBasisEffectivenessChart) entryBasisEffectivenessChart.update();
            if (factorAnalysisChart) factorAnalysisChart.update();
        }


        // Window onload에서 Firebase 초기화 호출
        window.onload = function() {
            // 저장된 테마 설정 로드
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark-mode');
            }
            
            // HTML 요소들을 찾기 위한 변수들을 스크립트 상단으로 이동하거나, 직접 접근하도록 변경
            // 모달 닫기 버튼 이벤트
            const confirmModalCloseBtn = document.getElementById('confirmModalClose');
            if (confirmModalCloseBtn) { // 요소가 존재하는지 확인
                confirmModalCloseBtn.addEventListener('click', hideConfirmModal);
            }
            const cancelDeleteBtn = document.getElementById('cancelDelete');
            if (cancelDeleteBtn) { // 요소가 존재하는지 확인
                cancelDeleteBtn.addEventListener('click', hideConfirmModal);
            }


            document.getElementById('date').value = new Date().toISOString().split('T')[0]; // Set default entry date to today
            initializeCharts(); // 차트 초기화는 색상 업데이트보다 먼저!
            updateChartColors(savedTheme === 'dark'); // 다크 모드 초기화 후 차트 색상 업데이트
            updateResultFieldRequirements(); // Set initial required status
            initializeFirebase(); // Firebase 초기화
            
            // Service Worker 등록
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('Service Worker 등록 성공:', registration);
                    })
                    .catch(error => {
                        console.error('Service Worker 등록 실패:', error);
                    });
            }
        };


        const tradeForm = document.getElementById('tradeForm');
        const tradeHistoryBody = document.getElementById('tradeHistoryBody');
        window.trades = []; // Firebase에서 관리되므로 초기화 시 빈 배열로 시작합니다.

        // Chart instances, will be initialized in initializeCharts()
        let resultBreakdownChart;
        let psychologyImpactChart;
        let entryBasisEffectivenessChart;
        let factorAnalysisChart;

        const resultOutcomeSelect = document.getElementById('resultOutcome');
        const rRatioInput = document.getElementById('rRatio');
        const exitReasonSelect = document.getElementById('exitReason');
        const replayQuestion1Select = document.getElementById('replayQuestion1');
        const replayQuestion2Textarea = document.getElementById('replayQuestion2');
        const replayQuestion3Input = document.getElementById('replayQuestion3');
        const exitDateInput = document.getElementById('exitDate');

        let currentEditingTradeId = null; // 수정 중인 매매 ID 추적

        // 모달 관련 요소
        const confirmModalOverlay = document.getElementById('confirmModalOverlay');
        const confirmDeleteButton = document.getElementById('confirmDelete');
        let tradeIdToDelete = null;

        // Utility function to wrap long labels
        function wrapLabel(label, maxCharsPerLine) {
            if (typeof label !== 'string') return label;
            if (label.length <= maxCharsPerLine) return label;
            const words = label.split(' ');
            let lines = [];
            let currentLine = '';
            words.forEach(word => {
                if ((currentLine + word).length > maxCharsPerLine && currentLine.length > 0) {
                    lines.push(currentLine.trim());
                    currentLine = word + ' ';
                } else {
                    currentLine += word + ' ';
                }
            });
            lines.push(currentLine.trim());
            return lines;
        }

        // Initialize Charts (This function needs to be defined BEFORE it's called in window.onload)
        function initializeCharts() {
            const commonChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                size: 12
                            },
                            color: 'var(--text-primary)' // Dynamic text color
                        }
                    },
                    tooltip: { // 툴팁 옵션 추가
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== undefined) {
                                    label += context.parsed.y.toFixed(2) + '%';
                                } else if (context.parsed.x !== undefined) {
                                    label += context.parsed.x;
                                } else if (context.parsed !== undefined) {
                                    label += context.parsed.toFixed(2) + '%';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            },
                            color: 'var(--text-primary)' // Dynamic text color
                        },
                        grid: { // 그리드 라인 설정
                            display: true,
                            drawBorder: false,
                            color: 'var(--chart-grid-color)' // Dynamic grid color
                        }
                    },
                    x: {
                        ticks: {
                            callback: function(value, index, values) {
                                return wrapLabel(this.getLabelForValue(value), 16);
                            },
                            autoSkip: false,
                            maxRotation: 45,
                            minRotation: 0,
                            color: 'var(--text-primary)' // Dynamic text color
                        },
                        grid: { // 그리드 라인 설정
                            display: false // X축 그리드 라인은 보통 숨김
                        }
                    }
                },
                layout: {
                    padding: { // 차트 가장자리 패딩 추가
                        left: 20,
                        right: 20,
                        top: 20,
                        bottom: 20
                    }
                }
            };

            const resultBreakdownCtx = document.getElementById('resultBreakdownChart').getContext('2d');
            resultBreakdownChart = new Chart(resultBreakdownCtx, {
                type: 'doughnut',
                data: {
                    labels: ['수익', '손절', '본절', '진행 중'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#6a994e', '#d9534f', '#f0ad4e', '#888888'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                },
                                color: 'var(--text-primary)' // Dynamic text color
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                                    const percentage = total > 0 ? (value / total * 100).toFixed(2) : 0;
                                    return `${label}: ${percentage}%`;
                                }
                            }
                        }
                    },
                    layout: {
                        padding: { // 도넛 차트 패딩 추가
                            left: 10,
                            right: 10,
                            top: 10,
                            bottom: 10
                        }
                    }
                }
            });

            const psychologyImpactCtx = document.getElementById('psychologyImpactChart').getContext('2d');
            psychologyImpactChart = new Chart(psychologyImpactCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '승률 (%)',
                        data: [],
                        backgroundColor: '#a0c4ff',
                        borderColor: '#80b0f0',
                        borderWidth: 1
                    }]
                },
                options: commonChartOptions
            });

            const entryBasisEffectivenessCtx = document.getElementById('entryBasisEffectivenessChart').getContext('2d');
            entryBasisEffectivenessChart = new Chart(entryBasisEffectivenessCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '승률 (%)',
                        data: [],
                        backgroundColor: '#6a994e',
                        borderColor: '#5a8542',
                        borderWidth: 1
                    }]
                },
                options: commonChartOptions
            });

            const factorAnalysisCtx = document.getElementById('factorAnalysisChart').getContext('2d');
            factorAnalysisChart = new Chart(factorAnalysisCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '빈도',
                        data: [],
                        backgroundColor: '#f0ad4e',
                        borderColor: '#d99436',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.x;
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0,
                                color: 'var(--text-primary)' // Dynamic text color
                            },
                            grid: { // 그리드 라인 설정
                                display: true,
                                drawBorder: false,
                                color: 'var(--chart-grid-color)' // Dynamic grid color
                            }
                        },
                        y: {
                            ticks: {
                                callback: function(value, index, values) {
                                    return wrapLabel(this.getLabelForValue(value), 25);
                                },
                                autoSkip: false,
                                maxRotation: 0,
                                minRotation: 0,
                                color: 'var(--text-primary)' // Dynamic text color
                            },
                            grid: { // 그리드 라인 설정
                                display: false // Y축 그리드 라인은 보통 숨김
                            }
                        }
                    },
                    layout: {
                        padding: { // 가로 막대 차트 패딩 추가
                            left: 20,
                            right: 20,
                            top: 20,
                            bottom: 20
                        }
                    }
                }
            });
        }

        // Update Charts and Summary
        function updateDashboard() {
            if (!window.trades) {
                console.warn("Trades data is not available yet.");
                return;
            }
            const completedTrades = window.trades.filter(t => t.resultOutcome !== '진행 중');

            // Overall Performance
            const totalTrades = completedTrades.length;
            document.getElementById('totalTrades').textContent = totalTrades;

            const winTrades = completedTrades.filter(t => t.resultOutcome === '수익').length;
            const winRate = totalTrades > 0 ? (winTrades / totalTrades * 100).toFixed(2) : 0;
            document.getElementById('winRate').textContent = `${winRate}%`;

            const totalRR = completedTrades.reduce((sum, t) => sum + (parseFloat(t.rRatio) || 0), 0);
            const avgRR = totalTrades > 0 ? (totalRR / totalTrades).toFixed(2) : 0;
            document.getElementById('avgRR').textContent = avgRR;

            // Result Breakdown Chart
            const resultCounts = { '수익': 0, '손절': 0, '본절': 0, '진행 중': 0 };
            window.trades.forEach(trade => {
                if (resultCounts[trade.resultOutcome] !== undefined) {
                    resultCounts[trade.resultOutcome]++;
                }
            });
            if (resultBreakdownChart) { // Ensure chart exists before updating
                resultBreakdownChart.data.datasets[0].data = [resultCounts['수익'], resultCounts['손절'], resultCounts['본절'], resultCounts['진행 중']];
                resultBreakdownChart.update();
            }


            // Psychology Impact Chart (only for completed trades)
            const psychologyWinRates = {};
            const allPsychologyTags = new Set([...predefinedPsychologyTags, ...window.customPsychologyTags]); // 미리 정의된 태그와 사용자 정의 태그 결합

            completedTrades.forEach(trade => {
                const psychologyTags = Array.isArray(trade.psychology) ? trade.psychology : [];
                psychologyTags.forEach(tag => {
                    if (!psychologyWinRates[tag]) {
                        psychologyWinRates[tag] = { wins: 0, total: 0 };
                    }
                    psychologyWinRates[tag].total++;
                    if (trade.resultOutcome === '수익') {
                        psychologyWinRates[tag].wins++;
                    }
                });
            });

            const psychologyLabels = Array.from(allPsychologyTags).sort();
            const psychologyData = psychologyLabels.map(tag => {
                if (psychologyWinRates[tag] && psychologyWinRates[tag].total > 0) {
                    return (psychologyWinRates[tag].wins / psychologyWinRates[tag].total * 100).toFixed(2);
                }
                return 0; // 데이터가 없는 태그는 0%
            });

            if (psychologyImpactChart) { // Ensure chart exists before updating
                psychologyImpactChart.data.labels = psychologyLabels;
                psychologyImpactChart.data.datasets[0].data = psychologyData;
                psychologyImpactChart.update();
            }


            // Entry Basis Effectiveness Chart (only for completed trades)
            const entryBasisWinRates = {};
            const allEntryBasisTags = new Set([...predefinedEntryBasisTags, ...window.customEntryBasisTags]); // 미리 정의된 태그와 사용자 정의 태그 결합

            completedTrades.forEach(trade => {
                const entryBasisTags = Array.isArray(trade.entryBasis) ? trade.entryBasis : [];
                entryBasisTags.forEach(tag => {
                    if (!entryBasisWinRates[tag]) {
                        entryBasisWinRates[tag] = { wins: 0, total: 0 };
                    }
                    entryBasisWinRates[tag].total++;
                    if (trade.resultOutcome === '수익') {
                        entryBasisWinRates[tag].wins++;
                    }
                });
            });

            const entryBasisLabels = Array.from(allEntryBasisTags).sort();
            const entryBasisData = entryBasisLabels.map(tag => {
                if (entryBasisWinRates[tag] && entryBasisWinRates[tag].total > 0) {
                    return (entryBasisWinRates[tag].wins / entryBasisWinRates[tag].total * 100).toFixed(2);
                }
                return 0; // 데이터가 없는 태그는 0%
            });

            if (entryBasisEffectivenessChart) { // Ensure chart exists before updating
                entryBasisEffectivenessChart.data.labels = entryBasisLabels;
                entryBasisEffectivenessChart.data.datasets[0].data = entryBasisData;
                entryBasisEffectivenessChart.update();
            }


            // Success/Failure Factor Analysis Chart (only for completed trades)
            const factorCounts = {};
            completedTrades.forEach(trade => {
                const factors = Array.isArray(trade.factors) ? trade.factors : [];
                factors.forEach(factor => {
                    factorCounts[factor] = (factorCounts[factor] || 0) + 1;
                });
            });

            const sortedFactors = Object.entries(factorCounts).sort(([, a], [, b]) => b - a);
            if (factorAnalysisChart) { // Ensure chart exists before updating
                factorAnalysisChart.data.labels = sortedFactors.map(f => f[0]);
                factorAnalysisChart.data.datasets[0].data = sortedFactors.map(f => f[1]);
                factorAnalysisChart.update();
            }
        }

        // Render Trade History Table
        function renderTradeHistory() {
            tradeHistoryBody.innerHTML = '';
            if (!window.trades) {
                return;
            }
            window.trades.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date descending
            window.trades.forEach(trade => {
                let holdingPeriod = '';
                if (trade.date && trade.exitDate && trade.resultOutcome !== '진행 중') {
                    const entry = new Date(trade.date);
                    const exit = new Date(trade.exitDate);
                    const diffTime = Math.abs(exit - entry);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    holdingPeriod = `${diffDays} 일`;
                } else if (trade.resultOutcome === '진행 중') {
                    holdingPeriod = '진행 중';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${trade.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${trade.exitDate || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${holdingPeriod || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${trade.stockName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${trade.tradeType}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${trade.resultOutcome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${trade.rRatio !== null ? trade.rRatio : '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-800 dark:text-gray-200">${Array.isArray(trade.psychology) ? trade.psychology.join(', ') : ''}</td>
                    <td class="px-6 py-4 text-sm text-gray-800 dark:text-gray-200">${Array.isArray(trade.entryBasis) ? trade.entryBasis.join(', ') : ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editTrade('${trade.id}')" class="text-indigo-600 hover:text-indigo-900 ml-2 dark:text-indigo-400 dark:hover:text-indigo-200">수정</button>
                        <button onclick="showConfirmModal('${trade.id}')" class="text-red-600 hover:text-red-900 ml-2 dark:text-red-400 dark:hover:text-red-200">삭제</button>
                    </td>
                `;
                tradeHistoryBody.appendChild(row);
            });
        }

        // Function to populate form for editing
        window.editTrade = function(tradeId) {
            const tradeToEdit = window.trades.find(t => t.id === tradeId);
            if (!tradeToEdit) return;

            document.getElementById('date').value = tradeToEdit.date;
            document.getElementById('stockName').value = tradeToEdit.stockName;
            document.querySelector(`input[name="tradeType"][value="${tradeToEdit.tradeType}"]`).checked = true;
            document.getElementById('entryPrice').value = tradeToEdit.entryPrice;
            document.getElementById('stopLossPrice').value = tradeToEdit.stopLossPrice || '';
            document.getElementById('targetPrice').value = tradeToEdit.targetPrice || '';
            document.getElementById('half').value = tradeToEdit.half || '';
            document.getElementById('weight').value = tradeToEdit.weight;
            document.getElementById('exitDate').value = tradeToEdit.exitDate || '';

            document.querySelectorAll('input[name="psychology"]').forEach(cb => cb.checked = false);
            if (Array.isArray(tradeToEdit.psychology)) {
                tradeToEdit.psychology.forEach(tag => {
                    const checkbox = document.querySelector(`input[name="psychology"][value="${tag}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }

            document.querySelectorAll('input[name="entryBasis"]').forEach(cb => cb.checked = false);
            if (Array.isArray(tradeToEdit.entryBasis)) {
                tradeToEdit.entryBasis.forEach(tag => {
                    const checkbox = document.querySelector(`input[name="entryBasis"][value="${tag}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }

            resultOutcomeSelect.value = tradeToEdit.resultOutcome;
            rRatioInput.value = tradeToEdit.rRatio || '';
            exitReasonSelect.value = tradeToEdit.exitReason || '';

            document.querySelectorAll('input[name="factor"]').forEach(cb => cb.checked = false);
            if (Array.isArray(tradeToEdit.factors)) {
                tradeToEdit.factors.forEach(factor => {
                    const checkbox = document.querySelector(`input[name="factor"][value="${factor}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }

            replayQuestion1Select.value = tradeToEdit.replayQuestion1 || '';
            replayQuestion2Textarea.value = tradeToEdit.replayQuestion2 || '';
            replayQuestion3Input.value = tradeToEdit.replayQuestion3 || '';

            updateResultFieldRequirements();

            document.querySelector('#tradeForm button[type="submit"]').textContent = '매매 기록 업데이트';
            currentEditingTradeId = tradeId;

            document.getElementById('trade-entry').scrollIntoView({ behavior: 'smooth' });
        }

        // Function to show the confirmation modal
        window.showConfirmModal = function(tradeId) {
            tradeIdToDelete = tradeId;
            confirmModalOverlay.classList.remove('hidden');
        }

        // Function to hide the confirmation modal
        function hideConfirmModal() {
            confirmModalOverlay.classList.add('hidden');
            tradeIdToDelete = null;
        }

        // Handle actual delete logic
        confirmDeleteButton.addEventListener('click', async () => {
            if (!tradeIdToDelete) return;

            if (!window.db || !window.currentUserId || !window.userTradesCollectionRef) {
                document.getElementById('statusMessage').textContent = '데이터베이스가 아직 준비되지 않았습니다. 잠시 후 다시 시도해주세요.';
                document.getElementById('statusMessage').classList.remove('hidden');
                return;
            }

            document.getElementById('loadingSpinner').classList.remove('hidden');
            document.getElementById('statusMessage').classList.add('hidden');

            try {
                await window.deleteDoc(window.doc(window.userTradesCollectionRef, tradeIdToDelete));
                document.getElementById('statusMessage').textContent = '매매 기록이 성공적으로 삭제되었습니다!';
                document.getElementById('statusMessage').classList.remove('hidden');
                document.getElementById('statusMessage').classList.remove('text-red-600', 'bg-red-100', 'border-red-200');
                document.getElementById('statusMessage').classList.add('text-green-600', 'bg-green-100', 'border-green-200');
                hideConfirmModal();
                // 데이터는 onSnapshot을 통해 자동으로 업데이트되므로, 직접 렌더링/대시보드 업데이트 불필요
            } catch (error) {
                console.error("매매 기록 삭제 실패:", error);
                document.getElementById('statusMessage').textContent = '매매 기록 삭제 실패: ' + error.message;
                document.getElementById('statusMessage').classList.remove('hidden');
                document.getElementById('statusMessage').classList.remove('text-green-600', 'bg-green-100', 'border-red-200');
                document.getElementById('statusMessage').classList.add('text-red-600', 'bg-red-100', 'border-red-200');
            } finally {
                document.getElementById('loadingSpinner').classList.add('hidden');
            }
        });


        // Function to update required status of result fields
        function updateResultFieldRequirements() {
            const isCompleted = resultOutcomeSelect.value !== '진행 중';

            rRatioInput.required = isCompleted;
            exitReasonSelect.required = isCompleted;
            replayQuestion1Select.required = isCompleted;

            rRatioInput.placeholder = isCompleted ? "예: 1.5 (수익), 0.8 (손절)" : "진행 중인 매매는 선택 사항";
            exitReasonSelect.querySelector('option[value=""]').textContent = isCompleted ? "선택하세요" : "진행 중인 매매는 선택 사항";
            replayQuestion1Select.querySelector('option[value=""]').textContent = isCompleted ? "선택하세요" : "진행 중인 매매는 선택 사항";

            if (!isCompleted && currentEditingTradeId === null) {
                rRatioInput.value = '';
                exitReasonSelect.value = '';
                replayQuestion1Select.value = '';
                replayQuestion2Textarea.value = '';
                replayQuestion3Input.value = '';
                document.querySelectorAll('input[name="factor"]').forEach(cb => cb.checked = false); // 초기화 시 초기화
            }
        }

        // Event listener for resultOutcome change
        resultOutcomeSelect.addEventListener('change', updateResultFieldRequirements);

        // Handle Form Submission
        tradeForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            if (!window.db || !window.currentUserId || !window.userTradesCollectionRef) {
                document.getElementById('statusMessage').textContent = '데이터베이스가 아직 준비되지 않았습니다. 잠시 후 다시 시도해주세요.';
                document.getElementById('statusMessage').classList.remove('hidden');
                return;
            }

            document.getElementById('loadingSpinner').classList.remove('hidden');
            document.getElementById('statusMessage').classList.add('hidden');

            const tradeData = {
                date: document.getElementById('date').value,
                stockName: document.getElementById('stockName').value,
                tradeType: document.querySelector('input[name="tradeType"]:checked').value,
                entryPrice: parseFloat(document.getElementById('entryPrice').value),
                stopLossPrice: parseFloat(document.getElementById('stopLossPrice').value) || null,
                targetPrice: parseFloat(document.getElementById('targetPrice').value) || null,
                half: parseFloat(document.getElementById('half').value) || null,
                weight: parseFloat(document.getElementById('weight').value),
                exitDate: document.getElementById('exitDate').value || null,
                psychology: Array.from(document.querySelectorAll('input[name="psychology"]:checked')).map(cb => cb.value),
                entryBasis: Array.from(document.querySelectorAll('input[name="entryBasis"]:checked')).map(cb => cb.value),
                resultOutcome: resultOutcomeSelect.value,
                rRatio: parseFloat(rRatioInput.value) || null,
                exitReason: exitReasonSelect.value || null,
                factors: Array.from(document.querySelectorAll('input[name="factor"]:checked')).map(cb => cb.value),
                replayQuestion1: replayQuestion1Select.value || null,
                replayQuestion2: replayQuestion2Textarea.value || null,
                replayQuestion3: parseInt(replayQuestion3Input.value) || null,
                timestamp: Date.now() // 최신순 정렬을 위한 타임스탬프
            };

            try {
                if (currentEditingTradeId) {
                    // 기존 매매 업데이트
                    await window.setDoc(window.doc(window.userTradesCollectionRef, currentEditingTradeId), tradeData);
                    document.getElementById('statusMessage').textContent = '매매 기록이 업데이트되었습니다!';
                    document.getElementById('statusMessage').classList.remove('hidden');
                } else {
                    // 새로운 매매 추가 (Firestore가 자동으로 ID 생성)
                    await window.setDoc(window.doc(window.userTradesCollectionRef, String(tradeData.timestamp)), tradeData); // 타임스탬프를 ID로 사용
                    document.getElementById('statusMessage').textContent = '새로운 매매 기록이 저장되었습니다!';
                    document.getElementById('statusMessage').classList.remove('hidden');
                }
                document.getElementById('statusMessage').classList.remove('text-red-600', 'bg-red-100', 'border-red-200');
                document.getElementById('statusMessage').classList.add('text-green-600', 'bg-green-100', 'border-green-200');

                tradeForm.reset(); // Clear form after submission
                document.getElementById('date').value = new Date().toISOString().split('T')[0]; // Reset date to today
                document.getElementById('exitDate').value = ''; // Clear exit date
                currentEditingTradeId = null; // Reset editing state
                document.querySelector('#tradeForm button[type="submit"]').textContent = '매매 기록 저장'; // Reset button text

                // 데이터는 onSnapshot을 통해 자동으로 업데이트되므로, 직접 렌더링/대시보드 업데이트 불필요
            } catch (error) {
                console.error("매매 기록 저장/업데이트 실패:", error);
                document.getElementById('statusMessage').textContent = '매매 기록 저장/업데이트 실패: ' + error.message;
                document.getElementById('statusMessage').classList.remove('hidden');
                document.getElementById('statusMessage').classList.remove('text-green-600', 'bg-green-100', 'border-red-200');
                document.getElementById('statusMessage').classList.add('text-red-600', 'bg-red-100', 'border-red-200');
            } finally {
                document.getElementById('loadingSpinner').classList.add('hidden');
            }
        });

        // Report related logic
        const reportPeriodRadios = document.querySelectorAll('input[name="reportPeriod"]');
        const reportDateSelector = document.getElementById('reportDateSelector');
        
        // Set default month for reportDateSelector to current month
        const today = new Date();
        const year = today.getFullYear();
        const month = (today.getMonth() + 1).toString().padStart(2, '0');
        reportDateSelector.value = `${year}-${month}`;

        reportPeriodRadios.forEach(radio => {
            radio.addEventListener('change', updateReports);
        });
        reportDateSelector.addEventListener('change', updateReports);

        function updateReports() {
            if (!window.trades || window.trades.length === 0) {
                document.getElementById('reportTotalTrades').textContent = '0';
                document.getElementById('reportWinRate').textContent = '0.00%';
                document.getElementById('reportAvgRR').textContent = '0.00';
                document.getElementById('reportTotalPNL').textContent = '0.00';
                return;
            }

            const selectedPeriodType = document.querySelector('input[name="reportPeriod"]:checked').value;
            const selectedDate = reportDateSelector.value; // YYYY-MM or YYYY

            let filteredTrades = [];

            if (selectedPeriodType === 'monthly') {
                const [year, month] = selectedDate.split('-');
                filteredTrades = window.trades.filter(trade => {
                    const tradeDate = new Date(trade.date);
                    return tradeDate.getFullYear() === parseInt(year) && (tradeDate.getMonth() + 1) === parseInt(month);
                });
            } else if (selectedPeriodType === 'quarterly') {
                const [yearStr, monthStr] = selectedDate.split('-'); // Still uses month selector for quarter
                const currentMonth = parseInt(monthStr);
                const quarter = Math.floor((currentMonth - 1) / 3) + 1; // 1-4
                
                filteredTrades = window.trades.filter(trade => {
                    const tradeDate = new Date(trade.date);
                    const tradeQuarter = Math.floor((tradeDate.getMonth()) / 3) + 1;
                    return tradeDate.getFullYear() === parseInt(yearStr) && tradeQuarter === quarter;
                });
            }

            const completedFilteredTrades = filteredTrades.filter(t => t.resultOutcome !== '진행 중');

            const totalTrades = completedFilteredTrades.length;
            const winTrades = completedFilteredTrades.filter(t => t.resultOutcome === '수익').length;
            const totalRR = completedFilteredTrades.reduce((sum, t) => sum + (parseFloat(t.rRatio) || 0), 0);
            const totalPNL = completedFilteredTrades.reduce((sum, t) => {
                const rRatio = parseFloat(t.rRatio) || 0;
                // Assuming R-Ratio directly translates to profit/loss percentage for simplicity in reports
                // For a more accurate P&L, you would need actual profit/loss values or initial capital + R-ratio logic
                return sum + (t.resultOutcome === '수익' ? rRatio : -rRatio);
            }, 0);


            document.getElementById('reportTotalTrades').textContent = totalTrades;
            document.getElementById('reportWinRate').textContent = `${totalTrades > 0 ? (winTrades / totalTrades * 100).toFixed(2) : 0.00}%`;
            document.getElementById('reportAvgRR').textContent = `${totalTrades > 0 ? (totalRR / totalTrades).toFixed(2) : 0.00}`;
            document.getElementById('reportTotalPNL').textContent = `${totalPNL.toFixed(2)}`;
        }

    </script>
    <style>
        /* 다크 모드 스타일 */
        :root {
            --bg-primary: #f8f5f2; /* Light background */
            --bg-secondary: #ffffff; /* Card/Container background */
            --bg-tertiary: #f3f0ed; /* Section/Hover background */
            --text-primary: #333; /* Main text color */
            --text-secondary: #555; /* Label/Muted text color */
            --text-heading: #1a202c; /* Heading color */
            --text-link: #6a994e; /* Primary accent color */
            --border-color: #ddd; /* General border color */
            --shadow-color: rgba(0, 0, 0, 0.05); /* Soft shadow */
            --input-bg: #fff; /* Input field background */
            --input-border: #ddd; /* Input field border */
            --button-primary-bg: #6a994e;
            --button-primary-hover: #5a8542;
            --button-secondary-bg: #f0ad4e;
            --button-secondary-hover: #ec971f;
            --button-danger-bg: #d9534f;
            --button-danger-hover: #c9302c;
            --chart-bg: #ffffff;
            --chart-grid-color: rgba(0, 0, 0, 0.1);
        }

        .dark-mode {
            --bg-primary: #1a202c; /* Dark background */
            --bg-secondary: #2d3748; /* Dark card/container background */
            --bg-tertiary: #4a5568; /* Dark section/hover background */
            --text-primary: #e2e8f0; /* Light text color */
            --text-secondary: #a0aec0; /* Muted light text color */
            --text-heading: #e2e8f0; /* Heading color in dark mode */
            --text-link: #a0c4ff; /* Accent blue for dark mode */
            --border-color: #4a5568; /* Dark border color */
            --shadow-color: rgba(0, 0, 0, 0.5); /* Stronger shadow in dark mode */
            --input-bg: #2d3748; /* Dark input field background */
            --input-border: #4a5568; /* Dark input field border */
            --button-primary-bg: #5a8542; /* Darker green for dark mode */
            --button-primary-hover: #4a743b;
            --button-secondary-bg: #d99436; /* Darker orange for dark mode */
            --button-secondary-hover: #c2832a;
            --button-danger-bg: #c9302c; /* Darker red for dark mode */
            --button-danger-hover: #b02a27;
            --chart-bg: #2d3748;
            --chart-grid-color: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        /* Added max-width and margin auto for centering */
        .container {
            max-width: 1024px; /* Adjust as needed, e.g., max-w-5xl, max-w-7xl */
            margin-left: auto;
            margin-right: auto;
            background-color: var(--bg-secondary);
            box-shadow: 0 4px 6px var(--shadow-color);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        section { /* General section styling for background and shadows */
            background-color: var(--bg-tertiary);
            box-shadow: inset 0 2px 4px var(--shadow-color);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        h1, h2, h3, h4 {
            color: var(--text-heading);
            transition: color 0.3s;
        }
        p, label {
            color: var(--text-secondary);
            transition: color 0.3s;
        }
        .chart-container {
            background-color: var(--chart-bg);
            box-shadow: 0 4px 6px var(--shadow-color);
            border: 1px solid var(--border-color); /* Add border for charts */
            transition: background-color 0.3s, box-shadow 0.3s, border-color 0.3s;
            height: 320px; /* Fixed height for charts to control size */
            display: flex; /* Use flex to center content vertically */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            padding: 1rem; /* Add some padding inside the chart container */
        }
        .chart-container canvas {
            max-height: 100%; /* Ensure canvas doesn't overflow its container */
            max-width: 100%; /* Ensure canvas doesn't overflow its container */
        }
        .input-group label {
            color: var(--text-secondary);
        }
        .input-group input[type="text"],
        .input-group input[type="number"],
        .input-group select,
        .input-group textarea,
        .input-group input[type="date"] {
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--text-primary);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.03);
            transition: border-color 0.3s, background-color 0.3s, color 0.3s;
        }
        .input-group input[type="text"]:focus,
        .input-group input[type="number"]:focus,
        .input-group select:focus,
        .input-group textarea:focus,
        .input-group input[type="date"]:focus {
            outline: none;
            border-color: var(--text-link); /* Accent blue */
            box-shadow: 0 0 0 3px rgba(160, 196, 255, 0.2); /* Keep light blue shadow for focus */
        }
        .btn-primary {
            background-color: var(--button-primary-bg);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.1s, color 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* Add shadow */
        }
        .btn-primary:hover {
            background-color: var(--button-primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .btn-danger {
            background-color: var(--button-danger-bg);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.1s, color 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .btn-danger:hover {
            background-color: var(--button-danger-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .btn-danger:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .btn-secondary {
            background-color: var(--button-secondary-bg);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.1s, color 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .btn-secondary:hover {
            background-color: var(--button-secondary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .btn-secondary:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* Dark mode toggle button */
        #darkModeToggle {
            background-color: var(--button-primary-bg); /* Use primary button color for consistency */
            color: white;
            box-shadow: 0 2px 4px var(--shadow-color);
        }
        .dark-mode #darkModeToggle {
            background-color: var(--button-primary-bg); /* Dark mode specific button color */
        }
        #darkModeToggle:hover {
            background-color: var(--button-primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }


        table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid var(--border-color); /* Table border */
            transition: border-color 0.3s;
        }
        th {
            background-color: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-secondary);
            transition: background-color 0.3s, color 0.3s;
        }
        td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: border-color 0.3s, color 0.3s;
        }
        tr:hover {
            background-color: var(--bg-tertiary);
            transition: background-color 0.3s;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6); /* Slightly darker overlay for dark mode */
        }
        .modal-content {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            box-shadow: 0 8px 16px var(--shadow-color);
            transition: background-color 0.3s, color 0.3s, box-shadow 0.3s;
        }
        .modal-header h3 {
            color: var(--text-heading);
        }
        .modal-close {
            color: var(--text-secondary);
        }
        .modal-close:hover {
            color: var(--text-primary);
        }
        .status-message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            font-weight: 500;
            text-align: center;
            background-color: var(--bg-secondary); /* Ensure it adapts */
            color: var(--text-primary); /* Ensure it adapts */
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        /* Specific status message colors to override the general ones for error/success */
        .status-message.text-red-600 { color: #ef4444; }
        .status-message.bg-red-100 { background-color: #fee2e2; }
        .status-message.border-red-200 { border-color: #fca5a5; }
        .dark-mode .status-message.text-red-600 { color: #f87171; }
        .dark-mode .status-message.bg-red-100 { background-color: #450a0a; }
        .dark-mode .status-message.border-red-200 { border-color: #7f1d1d; }

        .status-message.text-green-600 { color: #16a34a; }
        .status-message.bg-green-100 { background-color: #dcfce7; }
        .status-message.border-green-200 { border-color: #bbf7d0; }
        .dark-mode .status-message.text-green-600 { color: #4ade80; }
        .dark-mode .status-message.bg-green-100 { background-color: #0c4323; }
        .dark-mode .status-message.border-green-200 { border-color: #15803d; }

    </style>
</head>
<body class="p-4">
    <div class="container bg-white rounded-2xl shadow-lg p-6 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2">매매 일지 및 분석 대시보드</h1>
            <p class="text-lg">당신의 매매 기록을 체계적으로 관리하고 심리, 근거, 결과 간의 상관관계를 분석하세요.</p>
            <div id="authButtons" class="flex justify-center gap-4 mt-4">
                <button id="googleSignInBtn" onclick="signInWithGoogle()" class="bg-blue-600 text-white py-2 px-4 rounded-lg shadow hover:bg-blue-700 transition-colors hidden">
                    구글 로그인
                </button>
                <button id="signOutBtn" onclick="signOutUser()" class="bg-red-500 text-white py-2 px-4 rounded-lg shadow hover:bg-red-600 transition-colors hidden">
                    로그아웃
                </button>
            </div>
            <div id="userIdDisplay" class="text-sm text-gray-500 mt-2 dark:text-gray-400">사용자: 로딩 중...</div>
            <button id="darkModeToggle" onclick="toggleDarkMode()" class="mt-4 py-2 px-4 rounded-lg shadow">
                다크 모드 토글
            </button>
        </header>

        <div id="statusMessage" class="status-message hidden"></div>
        <div id="loadingSpinner" class="loading-spinner mx-auto hidden"></div>

        <section id="trade-entry" class="mb-10 p-6 rounded-xl shadow-inner">
            <h2 class="text-2xl font-semibold mb-6">새로운 매매 기록하기</h2>
            <p class="text-sm mb-6">이 섹션에서 당신의 매매에 대한 모든 세부 정보를 입력할 수 있습니다. 각 필드를 채우고, 해당되는 심리 태그와 진입 근거를 선택한 다음, 매매 결과를 기록하여 당신의 트레이딩 데이터를 축적하세요. 이미 기록된 매매를 수정하려면 아래 '매매 기록 히스토리'에서 '수정' 버튼을 클릭하세요.</p>

            <form id="tradeForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- 1. 기본정보 -->
                <div class="col-span-full">
                    <h3 class="text-xl font-medium mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">1. 기본 정보</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="input-group">
                            <label for="date" class="block text-sm mb-1">진입 날짜</label>
                            <input type="date" id="date" class="w-full rounded-md p-2">
                        </div>
                        <div class="input-group">
                            <label for="stockName" class="block text-sm mb-1">종목명</label>
                            <input type="text" id="stockName" class="w-full rounded-md p-2" placeholder="예: 삼성전자" required>
                        </div>
                        <div class="input-group flex items-center space-x-4">
                            <label class="text-sm">유형</label>
                            <div class="flex items-center">
                                <input type="radio" id="buy" name="tradeType" value="매수" class="mr-2" required>
                                <label for="buy" class="text-sm">매수</label>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" id="sell" name="tradeType" value="매도" class="mr-2">
                                <label for="sell" class="text-sm">매도</label>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="entryPrice" class="block text-sm mb-1">진입가</label>
                            <input type="number" id="entryPrice" class="w-full rounded-md p-2" step="0.000001" placeholder="예: 123.456789" required>
                        </div>
                        <div class="input-group">
                            <label for="stopLossPrice" class="block text-sm mb-1">손절가</label>
                            <input type="number" id="stopLossPrice" class="w-full rounded-md p-2" step="0.000001" placeholder="예: 120.000000">
                        </div>
                        <div class="input-group">
                            <label for="targetPrice" class="block text-sm mb-1">목표가</label>
                            <input type="number" id="targetPrice" class="w-full rounded-md p-2" step="0.000001" placeholder="예: 130.000000">
                        </div>
                        <div class="input-group">
                            <label for="half" class="block text-sm mb-1">하프 (부분 익절/손절 지점)</label>
                            <input type="number" id="half" class="w-full rounded-md p-2" step="0.000001" placeholder="선택 사항">
                        </div>
                        <div class="input-group">
                            <label for="weight" class="block text-sm mb-1">비중 (%)</label>
                            <input type="number" id="weight" class="w-full rounded-md p-2" step="0.1" placeholder="예: 10.5" required>
                        </div>
                    </div>
                </div>

                <!-- 2. 심리 태그 -->
                <div class="col-span-full">
                    <h3 class="text-xl font-medium mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">2. 심리 태그</h3>
                    <p class="text-sm mb-4">매매 당시의 당신의 심리 상태를 가장 잘 나타내는 태그들을 선택하세요.</p>
                    <div id="psychologyCheckboxes" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Psychology checkboxes will be rendered here by JavaScript -->
                    </div>
                </div>

                <!-- 3. 진입근거 -->
                <div class="col-span-full">
                    <h3 class="text-xl font-medium mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">3. 진입 근거</h3>
                    <p class="text-sm mb-4">매매 진입 시 사용했거나 고려했던 신호 기반의 근거들을 선택하세요.</p>
                    <div id="entryBasisCheckboxes" class="checkbox-group grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Entry Basis checkboxes will be rendered here by JavaScript -->
                    </div>
                </div>

                <!-- 4. 결과 -->
                <div class="col-span-full">
                    <h3 class="text-xl font-medium mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">4. 결과</h3>
                    <p class="text-sm mb-4">매매의 최종 결과와 그 원인을 진단하고, 리플레이 질문에 답변하여 다음 매매에 도움이 되는 통찰을 얻으세요.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="input-group">
                            <label for="resultOutcome" class="block text-sm mb-1">A. 매매 결과 요약: 결과</label>
                            <select id="resultOutcome" class="w-full rounded-md p-2">
                                <option value="">선택하세요</option>
                                <option value="수익">수익</option>
                                <option value="손절">손절</option>
                                <option value="본절">본절</option>
                                <option value="진행 중">진행 중</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="rRatio" class="block text-sm mb-1">손익비 (R-Ratio)</label>
                            <input type="number" id="rRatio" class="w-full rounded-md p-2" step="0.01" placeholder="예: 1.5 (수익), 0.8 (손절)">
                        </div>
                        <div class="input-group">
                            <label for="exitDate" class="block text-sm mb-1">청산 날짜</label>
                            <input type="date" id="exitDate" class="w-full rounded-md p-2">
                        </div>
                        <div class="input-group col-span-full">
                            <label for="exitReason" class="block text-sm mb-1">청산 이유</label>
                            <select id="exitReason" class="w-full rounded-md p-2">
                                <option value="">선택하세요</option>
                                <option value="계획 청산">계획 청산</option>
                                <option value="감정 청산">감정 청산</option>
                                <option value="급변 대응">급변 대응</option>
                                <option value="목표 도달 전 청산">목표 도달 전 청산</option>
                            </select>
                        </div>

                        <div class="checkbox-group col-span-full">
                            <h4 class="font-medium mb-2">B. 성공 요인/실패 요인 진단</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                <label class="block"><input type="checkbox" name="factor" value="진입 타이밍 정확" class="mr-2">진입 타이밍 정확</label>
                                <label class="block"><input type="checkbox" name="factor" value="시그널 해석 오류" class="mr-2">시그널 해석 오류</label>
                                <label class="block"><input type="checkbox" name="factor" value="계획 외 리스크 노출" class="mr-2">계획 외 리스크 노출</label>
                                <label class="block"><input type="checkbox" name="factor" value="감정 개입" class="mr-2">감정 개입</label>
                                <label class="block"><input type="checkbox" name="factor" value="오버트레이딩" class="mr-2">오버트레이딩</label>
                                <label class="block"><input type="checkbox" name="factor" value="목표가 미흡/비현실적" class="mr-2">목표가 미흡/비현실적</label>
                                <label class="block"><input type="checkbox" name="factor" value="외부 뉴스 영향 받음" class="mr-2">외부 뉴스 영향 받음</label>
                                <label class="block"><input type="checkbox" name="factor" value="시스템 외 매매" class="mr-2">시스템 외 매매</label>
                            </div>
                        </div>

                        <div class="input-group col-span-full">
                            <h4 class="font-medium mb-2">C. 리플레이 질문</h4>
                            <label for="replayQuestion1" class="block text-sm mb-1">이번 매매를 다시 한다면 똑같이 했을까?</label>
                            <select id="replayQuestion1" class="w-full rounded-md p-2">
                                <option value="">선택하세요</option>
                                <option value="예">예</option>
                                <option value="아니오">아니오</option>
                            </select>
                        </div>
                        <div class="input-group col-span-full">
                            <label for="replayQuestion2" class="block text-sm mb-1">감정이 개입된 순간은 언제였나?</label>
                            <textarea id="replayQuestion2" class="w-full h-20 rounded-md p-2" placeholder="자유롭게 작성하세요"></textarea>
                        </div>
                        <div class="input-group col-span-full">
                            <label for="replayQuestion3" class="block text-sm mb-1">운의 요소는 얼마나 있었나 (0~100%)?</label>
                            <input type="number" id="replayQuestion3" class="w-full rounded-md p-2" min="0" max="100" placeholder="0~100 사이 숫자">
                        </div>
                    </div>
                </div>

                <div class="col-span-full text-center mt-6">
                    <button type="submit" class="btn-primary">매매 기록 저장</button>
                </div>
            </form>
        </section>

        <section id="tag-management" class="mb-10 p-6 rounded-xl shadow-inner">
            <h2 class="text-2xl font-semibold mb-6">태그 관리</h2>
            <p class="text-sm mb-6">매매 기록에 사용할 심리 태그와 진입 근거를 직접 추가하거나 삭제할 수 있습니다. 추가된 태그는 모든 매매 기록에 즉시 반영됩니다.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-xl font-medium mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">심리 태그 관리</h3>
                    <div class="flex mb-4">
                        <input type="text" id="newPsychologyTag" class="w-full p-2 border rounded-md mr-2" placeholder="새 심리 태그 추가">
                        <button onclick="addCustomTag('psychology')" class="btn-primary flex-shrink-0">추가</button>
                    </div>
                    <div id="psychologyTagsDisplay" class="flex flex-wrap gap-2">
                        <!-- Custom psychology tags will be rendered here -->
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-medium mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">진입 근거 관리</h3>
                    <div class="flex mb-4">
                        <input type="text" id="newEntryBasisTag" class="w-full p-2 border rounded-md mr-2" placeholder="새 진입 근거 추가">
                        <button onclick="addCustomTag('entryBasis')" class="btn-primary flex-shrink-0">추가</button>
                    </div>
                    <div id="entryBasisTagsDisplay" class="flex flex-wrap gap-2">
                        <!-- Custom entry basis tags will be rendered here -->
                    </div>
                </div>
            </div>
        </section>

        <section id="trade-history" class="mb-10 p-6 rounded-xl shadow-inner">
            <h2 class="text-2xl font-semibold mb-6">매매 기록 히스토리</h2>
            <p class="text-sm mb-6">여기에 당신이 기록한 모든 매매 내역이 최신순으로 표시됩니다. 각 매매의 주요 정보를 한눈에 확인하고, 전체적인 흐름을 파악할 수 있습니다. '수정' 버튼을 클릭하여 진행 중인 매매를 업데이트하거나 완료할 수 있습니다.</p>
            <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-100 dark:bg-gray-800">
                        <tr>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider">진입 날짜</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider">청산 날짜</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider">보유 기간</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider">종목명</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider">유형</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider">결과</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider">손익비</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider">심리 태그</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider">진입 근거</th>
                            <th class="px-6 py-3 text-xs font-medium uppercase tracking-wider">액션</th>
                        </tr>
                    </thead>
                    <tbody id="tradeHistoryBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- Trade entries will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </section>

        <section id="analysis-dashboard" class="mb-10 p-6 rounded-xl shadow-inner">
            <h2 class="text-2xl font-semibold mb-6">매매 분석 대시보드</h2>
            <p class="text-sm mb-6">기록된 매매 데이터를 바탕으로 당신의 트레이딩 패턴과 심리, 진입 근거의 영향을 시각적으로 분석합니다. 차트를 통해 어떤 요소들이 당신의 매매 결과에 영향을 미치는지 파악하고 개선점을 찾을 수 있습니다.</p>

            <div class="grid grid-cols-1 gap-8"> <!-- Changed to single column grid -->
                <!-- Overall Performance -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 flex flex-col items-center justify-center text-center">
                    <h3 class="text-xl font-medium mb-4">전체 매매 성과 요약</h3>
                    <p class="text-sm mb-4">당신의 전체 매매 기록에 대한 핵심 지표를 확인하세요.</p>
                    <div class="flex flex-col sm:flex-row gap-6 text-2xl font-bold">
                        <div>
                            <span id="totalTrades" class="text-blue-600 dark:text-blue-400">0</span> <span class="text-lg">총 매매</span>
                        </div>
                        <div>
                            <span id="winRate" class="text-green-600 dark:text-green-400">0.00%</span> <span class="text-lg">승률</span>
                        </div>
                        <div>
                            <span id="avgRR" class="text-purple-600 dark:text-purple-400">0.00</span> <span class="text-lg">평균 손익비</span>
                        </div>
                    </div>
                </div>

                <!-- Result Breakdown Chart -->
                <div class="chart-container">
                    <h3 class="text-xl font-medium mb-4 text-center">매매 결과 분포</h3>
                    <p class="text-sm mb-4 text-center">수익, 손절, 본절 매매의 비율을 파악하여 당신의 매매 성향을 이해합니다.</p>
                    <canvas id="resultBreakdownChart"></canvas>
                </div>

                <!-- Psychology Impact Chart -->
                <div class="chart-container">
                    <h3 class="text-xl font-medium mb-4 text-center">심리 태그별 승률</h3>
                    <p class="text-sm mb-4 text-center">각 심리 상태가 당신의 매매 승률에 어떤 영향을 미치는지 시각적으로 확인하세요.</p>
                    <canvas id="psychologyImpactChart"></canvas>
                </div>

                <!-- Entry Basis Effectiveness Chart -->
                <div class="chart-container">
                    <h3 class="text-xl font-medium mb-4 text-center">진입 근거별 승률</h3>
                    <p class="text-sm mb-4 text-center">어떤 진입 근거가 가장 높은 승률을 보이는지 분석하여 전략을 개선하세요.</p>
                    <canvas id="entryBasisEffectivenessChart"></canvas>
                </div>

                <!-- Success/Failure Factor Analysis Chart -->
                <div class="chart-container"> <!-- Removed col-span-full as it's already a single column grid -->
                    <h3 class="text-xl font-medium mb-4 text-center">성공/실패 요인 빈도</h3>
                    <p class="text-sm mb-4 text-center">당신의 매매에서 가장 자주 나타나는 성공 및 실패 요인들을 파악합니다.</p>
                    <canvas id="factorAnalysisChart"></canvas>
                </div>
            </div>
        </section>

        <!-- New Section: Performance Reports -->
        <section id="performance-reports" class="mb-10 p-6 rounded-xl shadow-inner">
            <h2 class="text-2xl font-semibold mb-6">성과 보고서</h2>
            <p class="text-sm mb-6">월별 또는 분기별로 당신의 매매 성과를 요약하여 확인하세요.</p>

            <div class="flex flex-col sm:flex-row gap-4 mb-6 items-center">
                <label class="text-base font-medium">보고서 기간 선택:</label>
                <div class="flex gap-4">
                    <label class="flex items-center">
                        <input type="radio" name="reportPeriod" value="monthly" checked class="mr-2" id="reportPeriodMonthly">
                        월별
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="reportPeriod" value="quarterly" class="mr-2" id="reportPeriodQuarterly">
                        분기별
                    </label>
                </div>
                <input type="month" id="reportDateSelector" class="w-auto rounded-md p-2">
            </div>

            <div id="reportDisplay" class="bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                <h3 class="text-xl font-medium mb-4">선택 기간 성과 요약</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><strong>총 매매:</strong> <span id="reportTotalTrades">0</span></div>
                    <div><strong>승률:</strong> <span id="reportWinRate">0.00%</span></div>
                    <div><strong>평균 손익비:</strong> <span id="reportAvgRR">0.00</span></div>
                    <div><strong>총 수익/손실:</strong> <span id="reportTotalPNL">0.00</span></div>
                </div>
            </div>
        </section>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModalOverlay" class="modal-overlay hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-auto">
            <div class="modal-header flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">매매 기록 삭제 확인</h3>
                <button id="confirmModalClose" class="modal-close text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
            </div>
            <p class="mb-6 text-gray-700">정말 이 매매 기록을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.</p>
            <div class="flex justify-end gap-3">
                <button id="cancelDelete" class="btn-secondary px-4 py-2">취소</button>
                <button id="confirmDelete" class="btn-danger px-4 py-2">삭제</button>
            </div>
        </div>
    </div>
</body>
</html>
